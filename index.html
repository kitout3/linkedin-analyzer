<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur LinkedIn - ADN de Marque Cyrus Herez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // State management
        let state = {
            employees: [],
            // ===== NOUVEAUX MOTS-CLÃ‰S ADN CYRUS HEREZ =====
            adnKeywords: [
                { group: "Gestion de patrimoine", keywords: ["gestion de patrimoine", "gestion de fortune", "gestion privÃ©e"] },
                { group: "Accompagnement", keywords: ["accompagnement", "accompagnement patrimonial", "accompagnement clients"] },
                { group: "Structuration", keywords: ["structurer son patrimoine", "structurer votre patrimoine"] },
                { group: "Allocation", keywords: ["allocation d'actifs", "allocation d'actif"] },
                { group: "StratÃ©gie", keywords: ["stratÃ©gie"] },
                { group: "Sur-mesure", keywords: ["sur-mesure", "sur mesure"] },
                { group: "Optimisation", keywords: ["optimiser"] },
                { group: "SÃ©curisation", keywords: ["sÃ©curiser"] },
                { group: "Transmission", keywords: ["transmettre"] },
                { group: "Expertise", keywords: ["expertise patrimoniale", "ingÃ©nierie patrimoniale"] },
                { group: "Gestion financiÃ¨re", keywords: ["gestion financiÃ¨re"] },
                { group: "Immobilier", keywords: ["immobilier", "investissement immobilier"] },
                { group: "Produits structurÃ©s", keywords: ["produits structurÃ©s", "produit structurÃ©"] },
                { group: "Non cotÃ©", keywords: ["non cotÃ©", "non-cotÃ©"] }
            ],
            // ===== DÃ‰PARTEMENTS AVEC SECTIONS PONDÃ‰RÃ‰ES =====
            // Section 1: Coefficient 3 (plus important)
            // Section 2: Coefficient 2 (intermÃ©diaire)
            // Section 3: Coefficient 1 (complÃ©mentaire)
            departments: [
                { 
                    id: 1, 
                    name: "GÃ©rant PrivÃ©", 
                    sections: [
                        {
                            name: "Section 1 - CÅ“ur de mÃ©tier",
                            weight: 3,
                            keywords: [
                                "gestion de patrimoine", "gestion privÃ©e", "conseil patrimonial", "conseiller patrimonial",
                                "accompagnement patrimonial", "stratÃ©gie patrimoniale", "optimisation patrimoniale",
                                "transmission patrimoine", "ingÃ©nierie patrimoniale", "client privÃ©", "clientÃ¨le privÃ©e",
                                "bilan patrimonial", "audit patrimonial", "objectifs patrimoniaux", "planification patrimoniale",
                                "assurance vie", "contrat capitalisation", "allocation d'actifs", "diversification",
                                "Ã©pargne", "placements"
                            ]
                        },
                        {
                            name: "Section 2 - Expertise dirigeant",
                            weight: 2,
                            keywords: [
                                "transmission d'entreprise", "cession d'entreprise", "cession",
                                "rÃ©munÃ©ration du dirigeant", "optimiser sa rÃ©munÃ©ration", "optimiser sa fiscalitÃ©",
                                "protection de la famille", "gestion de la trÃ©sorerie", "anticiper sa retraite",
                                "transmettre son patrimoine", "succession", "donation", "dÃ©membrement",
                                "prÃ©conisations", "diagnostic", "wealth management"
                            ]
                        },
                        {
                            name: "Section 3 - Classes d'actifs",
                            weight: 1,
                            keywords: [
                                "classe d'actif", "produit structurÃ©", "produits structurÃ©s", "non cotÃ©", "non-cotÃ©",
                                "dette privÃ©e", "infrastructure", "private equity", "fond d'investissement",
                                "fonds d'investissement", "scpi", "allocation de scpi", "rÃ©sidentiel", "rÃ©sidentielle",
                                "compte titres", "performance", "gestion de fortune"
                            ]
                        }
                    ]
                },
                { 
                    id: 2, 
                    name: "GÃ©rant de Fortune", 
                    sections: [
                        {
                            name: "Section 1 - CÅ“ur de mÃ©tier",
                            weight: 3,
                            keywords: [
                                "gestion de fortune", "gestion privÃ©e", "gestion financiÃ¨re", "gestion actifs",
                                "gestion portefeuille", "portfolio management", "asset management",
                                "gÃ©rant", "gÃ©rante", "fund manager", "allocation d'actifs", "asset allocation",
                                "performance financiÃ¨re", "portefeuille", "portefeuilles", "analyse financiÃ¨re",
                                "marchÃ©s financiers", "investissement", "investissements", "valorisation",
                                "gestion de patrimoine"
                            ]
                        },
                        {
                            name: "Section 2 - Expertise technique",
                            weight: 2,
                            keywords: [
                                "risque", "gestion risque", "risk management", "volatilitÃ©", "rendement",
                                "obligations", "actions", "pricing", "analyste financier", "analyste",
                                "finance de marchÃ©", "transmission", "transmission d'entreprise", "optimisation",
                                "diversification", "classe d'actif", "produit structurÃ©", "produits structurÃ©s"
                            ]
                        },
                        {
                            name: "Section 3 - Actifs alternatifs",
                            weight: 1,
                            keywords: [
                                "immobilier", "investissement immobilier", "scpi", "opci", "sci", "fonciÃ¨re",
                                "immobilier locatif", "rendement locatif", "actif immobilier", "real estate",
                                "private equity", "capital investissement", "venture capital", "lbo",
                                "dette privÃ©e", "private debt", "infrastructure", "fonds alternatifs",
                                "co-investissement", "club deal", "non cotÃ©", "non-cotÃ©",
                                "fond d'investissement", "fonds d'investissement"
                            ]
                        }
                    ]
                }
            ],
            targetCompany: 'Cyrus Herez',
            currentView: 'list',
            selectedEmployee: null,
            companyMission: "Cyrus Herez accompagne les dirigeants, entrepreneurs et familles dans la construction, la sÃ©curisation et la transmission de leur patrimoine grÃ¢ce Ã  une approche globale intÃ©grant conseil stratÃ©gique, ingÃ©nierie patrimoniale, allocation financiÃ¨re, immobilier et investissements alternatifs.",
            // ParamÃ¨tres du score MÃ©tier
            metierMaxKeywords: 30, // Note maximale sur 30 mots-clÃ©s
        };

        // ===== FONCTIONS UTILITAIRES =====

        function loadState() {
            try {
                const saved = localStorage.getItem('employees_v3');
                if (saved) state.employees = JSON.parse(saved);
            } catch (e) {
                console.error('Error loading state:', e);
            }
        }

        function saveState() {
            localStorage.setItem('employees_v3', JSON.stringify(state.employees));
        }

        function processText(text) {
            return text.toLowerCase()
                .replace(/[^\w\sÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã¦Å“Ã§'-]/gi, ' ')
                .split(/\s+/)
                .filter(word => word.length > 2);
        }

        function normalizeText(text) {
            return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function extractLinkedInUsername(url) {
            if (!url) return '';
            const match = url.match(/linkedin\.com\/in\/([^\/\?]+)/);
            return match ? match[1] : '';
        }

        function isValidLinkedInURL(url) {
            return /linkedin\.com\/in\/[^\/\?]+/.test(url);
        }

        function extractProfileInfo(text) {
            const lines = text.split('\n').filter(l => l.trim());
            let firstName = '', lastName = '', position = '', company = '';
            
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].trim();
                const nameMatch = line.match(/^([A-ZÃ€-Ã¿][a-zÃ -Ã¿]+(?:\s+[A-ZÃ€-Ã¿][a-zÃ -Ã¿]+){0,2})\s*$/);
                if (nameMatch && line.length < 40) {
                    const parts = nameMatch[1].split(/\s+/);
                    if (parts.length >= 2) {
                        firstName = parts[0];
                        lastName = parts.slice(1).join(' ');
                        break;
                    }
                }
            }
            
            const positionKeywords = ['manager', 'director', 'ceo', 'cto', 'cfo', 'developer', 'engineer', 'consultant', 'analyst', 'specialist', 'coordinator', 'lead', 'head', 'chef', 'responsable', 'directeur', 'directrice', 'gÃ©rant', 'associÃ©', 'partner', 'founder', 'fondateur', 'conseiller', 'banquier'];
            for (const line of lines) {
                const lowerLine = line.toLowerCase();
                if (positionKeywords.some(keyword => lowerLine.includes(keyword))) {
                    position = line.trim();
                    break;
                }
            }
            
            for (const line of lines) {
                if (line.toLowerCase().includes('chez ') || line.toLowerCase().includes(' at ') || line.toLowerCase().includes('cyrus')) {
                    company = line.replace(/chez |at /gi, '').trim();
                    break;
                }
            }
            
            return { firstName, lastName, position, company };
        }

        function capitalizeWord(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function extractNameFromLinkedInUrl(url) {
            const username = extractLinkedInUsername(url);
            if (!username) return { firstName: '', lastName: '' };
            let slug = decodeURIComponent(username).toLowerCase().replace(/\d+/g, '').replace(/_/g, '-').replace(/\s+/g, '-');
            const parts = slug.split('-').filter(Boolean);
            if (parts.length === 0) return { firstName: '', lastName: '' };
            if (parts.length === 1) return { firstName: capitalizeWord(parts[0]), lastName: '' };
            if (parts.length === 2) return { firstName: capitalizeWord(parts[0]), lastName: capitalizeWord(parts[1]) };
            return { firstName: parts.slice(0, -1).map(capitalizeWord).join(' '), lastName: capitalizeWord(parts[parts.length - 1]) };
        }

        // ===== NOUVEAU CALCUL ADN CYRUS HEREZ =====
        function analyzeADN(profileText) {
            const normalizedText = normalizeText(profileText);
            const wordCount = processText(profileText).length;
            
            let foundGroups = [];
            let missingGroups = [];
            let totalGroups = state.adnKeywords.length;
            
            state.adnKeywords.forEach(group => {
                const normalizedKeywords = group.keywords.map(k => normalizeText(k));
                const found = normalizedKeywords.some(kw => normalizedText.includes(kw));
                const foundKeyword = group.keywords.find(kw => normalizedText.includes(normalizeText(kw)));
                
                if (found) {
                    foundGroups.push({ name: group.group, keyword: foundKeyword });
                } else {
                    missingGroups.push({ name: group.group, suggestions: group.keywords.slice(0, 2) });
                }
            });
            
            const globalScore = Math.round((foundGroups.length / totalGroups) * 100);
            
            return { 
                globalScore, 
                foundGroups, 
                missingGroups, 
                totalGroups,
                wordCount, 
                analyzedAt: new Date().toISOString() 
            };
        }

        // ===== SCORE SSI =====
        function calculateSSI(profileText, employee) {
            const text = profileText.toLowerCase();
            const words = processText(profileText);
            const wordCount = words.length;
            
            // 1. Marque professionnelle (25 pts)
            let brandScore = 0;
            brandScore += (employee.firstName && employee.lastName) ? 5 : 0;
            brandScore += employee.position ? 5 : 0;
            brandScore += wordCount >= 200 ? 10 : (wordCount >= 100 ? 5 : 0);
            brandScore += (text.includes('expert') || text.includes('spÃ©cialiste') || text.includes('passion')) ? 5 : 0;
            
            // 2. Trouver les bonnes personnes (25 pts)
            const networkKeywords = ['rÃ©seau', 'network', 'professionnel', 'contact', 'relation', 'partenaire', 'collaboration'];
            const peopleScore = Math.min(25, networkKeywords.filter(k => text.includes(k)).length * 4);
            
            // 3. Ã‰changer des informations (25 pts)
            const engageKeywords = ['partage', 'publication', 'article', 'insight', 'analyse', 'expertise', 'conseil', 'contribution'];
            const engagementScore = Math.min(25, engageKeywords.filter(k => text.includes(k)).length * 3.5);
            
            // 4. Ã‰tablir des relations (25 pts)
            const relationKeywords = ['accompagnement', 'Ã©coute', 'client', 'confiance', 'long-terme', 'long terme', 'fidÃ©litÃ©', 'suivi', 'proximitÃ©', 'partenariat', 'relation durable', 'sur-mesure', 'personnalisÃ©'];
            const relationScore = Math.min(25, relationKeywords.filter(k => text.includes(k)).length * 3);
            
            const ssiScore = Math.round(brandScore + peopleScore + engagementScore + relationScore);
            
            let sectorRanking = 50, networkRanking = 50;
            if (ssiScore >= 75) { sectorRanking = 10; networkRanking = 15; }
            else if (ssiScore >= 60) { sectorRanking = 20; networkRanking = 24; }
            else if (ssiScore >= 45) { sectorRanking = 35; networkRanking = 40; }
            else if (ssiScore >= 30) { sectorRanking = 50; networkRanking = 55; }
            
            return { 
                ssiScore, 
                ssiBrandScore: Math.round(brandScore), 
                ssiPeopleScore: Math.round(peopleScore), 
                ssiEngagementScore: Math.round(engagementScore), 
                ssiRelationScore: Math.round(relationScore), 
                ssiSectorRanking: sectorRanking, 
                ssiNetworkRanking: networkRanking, 
                ssiAvgSectorScore: 32, 
                ssiAvgNetworkScore: 36,
                ssiRelationKeywordsFound: relationKeywords.filter(k => text.includes(k))
            };
        }

        // ===== SCORE LINKEDIN PRO =====
        function calculateLinkedInScore(profileText, employee) {
            const text = profileText.toLowerCase();
            const normalizedText = normalizeText(text);
            const wordCount = processText(profileText).length;
            
            // 1. IDENTITÃ‰ & CRÃ‰DIBILITÃ‰ (15 pts)
            let photoScore = 0;
            const photoIndicators = ['photo', 'image', 'profil', 'portrait'];
            const hasPhotoMention = photoIndicators.some(p => text.includes(p));
            if (hasPhotoMention || wordCount > 150) photoScore = 3;
            else if (wordCount > 80) photoScore = 2;
            else photoScore = 0;
            
            let bannerScore = 0;
            const bannerIndicators = ['banniÃ¨re', 'banner', 'arriÃ¨re-plan', 'background', 'couverture'];
            const hasBannerMention = bannerIndicators.some(b => text.includes(b));
            if (hasBannerMention) bannerScore = 2;
            else if (wordCount > 200) bannerScore = 1;
            else bannerScore = 0;
            
            let headlineScore = 0;
            const hasCyrusHerez = text.includes('cyrus herez') || text.includes('cyrus-herez');
            const positionKeywords = ['gÃ©rant', 'conseiller', 'directeur', 'manager', 'responsable', 'associÃ©', 'partner', 'expert', 'consultant'];
            const hasPositionTitle = positionKeywords.some(k => normalizedText.includes(k));
            
            if (hasCyrusHerez && hasPositionTitle) headlineScore = 5;
            else if (hasCyrusHerez) headlineScore = 4;
            else if (hasPositionTitle && employee.position) headlineScore = 2;
            else if (employee.position) headlineScore = 1;
            else headlineScore = 0;
            
            const locationKeywords = ['paris', 'lyon', 'marseille', 'bordeaux', 'nantes', 'toulouse', 'lille', 'france', 'rÃ©gion', 'Ã®le-de-france'];
            const hasLocation = locationKeywords.some(l => normalizedText.includes(l));
            const hasCurrentJob = text.includes('actuel') || text.includes('current') || text.includes('prÃ©sent') || text.includes('depuis');
            const locationScore = (hasLocation ? 3 : 0) + (hasCurrentJob ? 2 : 0);
            
            const identityScore = photoScore + bannerScore + headlineScore + locationScore;
            
            // 2. PROPOSITION DE VALEUR (20 pts)
            let valuePropositionKeywordsFound = [];
            let valuePropositionKeywordsMissing = [];
            
            state.adnKeywords.forEach(group => {
                const normalizedKeywords = group.keywords.map(k => normalizeText(k));
                const found = normalizedKeywords.some(kw => normalizedText.includes(kw));
                const foundKeyword = group.keywords.find(kw => normalizedText.includes(normalizeText(kw)));
                
                if (found) {
                    valuePropositionKeywordsFound.push({ group: group.group, keyword: foundKeyword });
                } else {
                    valuePropositionKeywordsMissing.push(group.group);
                }
            });
            
            const valueRatio = valuePropositionKeywordsFound.length / state.adnKeywords.length;
            let summaryScore = Math.round(valueRatio * 10);
            
            const hasNumbers = /\d+/.test(text);
            const hasResults = ['rÃ©sultat', 'impact', 'rÃ©alis', 'atteint', 'dÃ©velopp', 'augment', 'rÃ©duit', 'optimis', 'amÃ©lio', 'gÃ©nÃ©rÃ©'].some(r => normalizedText.includes(r));
            if (hasNumbers && hasResults) summaryScore = Math.min(10, summaryScore + 2);
            
            let coherenceScore = 0;
            const deptKeywordsFound = employee.deptFoundKeywords?.length || 0;
            const deptTotal = employee.deptTotalKeywords || 1;
            const coherenceRatio = deptKeywordsFound / deptTotal;
            
            if (coherenceRatio >= 0.25) coherenceScore = 10;
            else if (coherenceRatio >= 0.15) coherenceScore = 7;
            else if (coherenceRatio >= 0.08) coherenceScore = 5;
            else coherenceScore = 2;
            
            const positioningScore = summaryScore + coherenceScore;
            
            // 3. EXPÃ‰RIENCE (25 pts)
            let experienceDetailScore = 0;
            const expKeywords = ['expÃ©rience', 'experience', 'poste', 'mission', 'responsab', 'projet', 'Ã©quipe', 'manage', 'pilote', 'dÃ©velopp'];
            const hasExpDetail = expKeywords.filter(k => normalizedText.includes(k)).length;
            const hasMetrics = /(\d+\s*%|\d+\s*[kKmM]?â‚¬|\d+\s*clients?|\d+\s*personnes?|\d+\s*projets?)/.test(text);
            const hasImpact = ['augment', 'rÃ©duit', 'crÃ©Ã©', 'lancÃ©', 'nÃ©goci', 'signÃ©', 'gÃ©nÃ©rÃ©', 'optimis'].some(i => normalizedText.includes(i));
            
            if (hasExpDetail >= 4 && hasMetrics && hasImpact) experienceDetailScore = 15;
            else if (hasExpDetail >= 3 && (hasMetrics || hasImpact)) experienceDetailScore = 12;
            else if (hasExpDetail >= 2 && hasMetrics) experienceDetailScore = 10;
            else if (hasExpDetail >= 2) experienceDetailScore = 8;
            else if (hasExpDetail >= 1) experienceDetailScore = 5;
            else experienceDetailScore = 3;
            
            let progressionScore = 0;
            const seniorityTerms = ['junior', 'confirmÃ©', 'senior', 'lead', 'manager', 'head', 'directeur', 'vp', 'chief', 'partner', 'associÃ©'];
            const progressionTerms = ['promu', 'Ã©volution', 'progression', 'nommÃ©', 'devenu', 'promotion'];
            const yearsPattern = /(\d+)\s*ans?/g;
            const yearsMatches = [...normalizedText.matchAll(yearsPattern)];
            const hasLongExp = yearsMatches.some(m => parseInt(m[1]) >= 5);
            const hasSeniority = seniorityTerms.filter(s => normalizedText.includes(s)).length >= 2;
            const hasProgression = progressionTerms.some(p => normalizedText.includes(p));
            
            if (hasProgression && hasSeniority) progressionScore = 10;
            else if (hasLongExp && hasSeniority) progressionScore = 8;
            else if (hasSeniority || hasLongExp) progressionScore = 6;
            else if (hasProgression) progressionScore = 5;
            else progressionScore = 3;
            
            const experienceScore = experienceDetailScore + progressionScore;
            
            // 4. COMPÃ‰TENCES (20 pts)
            let skillsScore = 0;
            const skillsKeywords = ['compÃ©tence', 'skill', 'expertise', 'maÃ®trise', 'connaissance', 'savoir-faire', 'spÃ©cialitÃ©'];
            const toolsFound = employee.atsFoundTools?.length || 0;
            const hasSkillsSection = skillsKeywords.some(s => normalizedText.includes(s));
            
            if (toolsFound >= 5 && hasSkillsSection) skillsScore = 10;
            else if (toolsFound >= 3 || (hasSkillsSection && deptKeywordsFound >= 5)) skillsScore = 8;
            else if (toolsFound >= 1 || deptKeywordsFound >= 3) skillsScore = 6;
            else if (hasSkillsSection) skillsScore = 4;
            else skillsScore = 2;
            
            let validationScore = 0;
            const recoMatch = normalizedText.match(/(\d+)\s*recommandation/i);
            const recoCount = recoMatch ? parseInt(recoMatch[1]) : 0;
            const endorsementKeywords = ['validÃ©', 'endorsed', 'recommand', 'tÃ©moign', 'rÃ©fÃ©rence'];
            const hasEndorsements = endorsementKeywords.some(e => normalizedText.includes(e));
            
            if (recoCount >= 5 && hasEndorsements) validationScore = 10;
            else if (recoCount >= 3 || hasEndorsements) validationScore = 7;
            else if (recoCount >= 1) validationScore = 5;
            else validationScore = 0;
            
            const competenceScore = skillsScore + validationScore;
            
            // 5. ENGAGEMENT (10 pts)
            let activityScore = 0;
            const activityKeywords = ['publication', 'article', 'post', 'partag', 'Ã©crit', 'publi', 'auteur', 'contributeur'];
            const hasActivity = activityKeywords.filter(a => normalizedText.includes(a)).length;
            
            if (hasActivity >= 3) activityScore = 5;
            else if (hasActivity >= 1) activityScore = 3;
            else activityScore = 0;
            
            let networkScore = 0;
            const extractNumber = (text, patterns) => {
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const numStr = match[1].replace(/[\s\u00A0\.]/g, '').replace(',', '');
                        return parseInt(numStr) || 0;
                    }
                }
                return 0;
            };
            
            const followerPatterns = [/([\d\s\u00A0.,]+)\s*abonn[Ã©e]s?/i, /([\d\s\u00A0.,]+)\s*followers?/i];
            const connexionPatterns = [/([\d\s\u00A0.,]+)\s*(?:relations?|connexions?|contacts?)/i, /plus de\s*([\d\s\u00A0.,]+)\s*(?:relations?|connexions?)/i];
            
            const followersCount = extractNumber(text, followerPatterns);
            const connexionsCount = extractNumber(text, connexionPatterns);
            const networkCount = Math.max(followersCount, connexionsCount);
            
            if (networkCount >= 10000) networkScore = 5;
            else if (networkCount >= 500 || text.includes('plus de 500')) networkScore = 5;
            else if (networkCount >= 200) networkScore = 4;
            else if (networkCount >= 100) networkScore = 3;
            else if (networkCount > 0) networkScore = 2;
            else networkScore = 1;
            
            const engagementScore = activityScore + networkScore;
            
            // 6. FORMATION (10 pts)
            let educationScore = 0;
            const educationKeywords = ['diplÃ´me', 'master', 'licence', 'bachelor', 'ingÃ©nieur', 'Ã©cole', 'universitÃ©', 'bac+', 'formation', 'mba', 'doctorat', 'phd'];
            const prestigeSchools = ['hec', 'essec', 'escp', 'edhec', 'polytechnique', 'centrale', 'mines', 'dauphine', 'sciences po', 'insead', 'em lyon'];
            const hasEducation = educationKeywords.filter(e => normalizedText.includes(e)).length;
            const hasPrestige = prestigeSchools.some(s => normalizedText.includes(s));
            
            if (hasPrestige) educationScore = 5;
            else if (hasEducation >= 2) educationScore = 5;
            else if (hasEducation >= 1) educationScore = 3;
            else educationScore = 0;
            
            let certScore = 0;
            const certKeywords = ['certifi', 'certified', 'certification', 'accrÃ©ditÃ©', 'agrÃ©Ã©', 'habilitÃ©', 'cfa', 'amf', 'cgp', 'cif', 'iobsp'];
            const hasCerts = certKeywords.filter(c => normalizedText.includes(c)).length;
            
            if (hasCerts >= 3) certScore = 5;
            else if (hasCerts >= 1) certScore = 4;
            else certScore = 0;
            
            const formationScore = educationScore + certScore;
            
            // SCORE TOTAL
            const linkedinGlobalScore = Math.min(100, identityScore + positioningScore + experienceScore + competenceScore + engagementScore + formationScore);
            
            // RÃˆGLES NO-GO
            const noGoReasons = [];
            if (!hasCyrusHerez) noGoReasons.push("'Cyrus Herez' absent du titre");
            if (experienceDetailScore < 5) noGoReasons.push("ExpÃ©riences non dÃ©taillÃ©es");
            if (headlineScore < 2) noGoReasons.push("Titre non professionnel");
            if (valuePropositionKeywordsFound.length < 3) noGoReasons.push("Proposition de valeur incomplÃ¨te");
            if (wordCount < 50) noGoReasons.push("Profil trop succinct");
            
            const isNoGo = noGoReasons.length >= 2;
            const finalScore = isNoGo ? Math.min(29, linkedinGlobalScore) : linkedinGlobalScore;
            
            let linkedinLevel, linkedinVerdict;
            if (isNoGo) {
                linkedinLevel = "ðŸ”´ Non pertinent";
                linkedinVerdict = "Profil Ã©liminÃ© (rÃ¨gles No-Go)";
            } else if (finalScore >= 85) {
                linkedinLevel = "ðŸ† Expert";
                linkedinVerdict = "Profil hautement pertinent";
            } else if (finalScore >= 70) {
                linkedinLevel = "âœ… Solide";
                linkedinVerdict = "Profil solide et exploitable";
            } else if (finalScore >= 50) {
                linkedinLevel = "âš ï¸ Moyen";
                linkedinVerdict = "Profil Ã  approfondir";
            } else if (finalScore >= 30) {
                linkedinLevel = "ðŸŸ  Faible";
                linkedinVerdict = "Profil peu diffÃ©renciant";
            } else {
                linkedinLevel = "ðŸ”´ Insuffisant";
                linkedinVerdict = "Profil non pertinent";
            }
            
            return { 
                linkedinGlobalScore: finalScore,
                linkedinLevel,
                linkedinVerdict,
                linkedinIsNoGo: isNoGo,
                linkedinNoGoReasons: noGoReasons,
                linkedinIdentityScore: identityScore,
                linkedinPhotoScore: photoScore,
                linkedinBannerScore: bannerScore,
                linkedinHeadlineScore: headlineScore,
                linkedinHasCyrusHerez: hasCyrusHerez,
                linkedinLocationScore: locationScore,
                linkedinPositioningScore: positioningScore,
                linkedinSummaryScore: summaryScore,
                linkedinCoherenceScore: coherenceScore,
                linkedinExperienceScore: experienceScore,
                linkedinExpDetailScore: experienceDetailScore,
                linkedinProgressionScore: progressionScore,
                linkedinCompetenceScore: competenceScore,
                linkedinSkillsScore: skillsScore,
                linkedinValidationScore: validationScore,
                linkedinEngagementScore: engagementScore,
                linkedinActivityScore: activityScore,
                linkedinNetworkScore: networkScore,
                linkedinFormationScore: formationScore,
                linkedinEducationScore: educationScore,
                linkedinCertScore: certScore,
                linkedinFollowersCount: followersCount,
                linkedinConnexionsCount: connexionsCount,
                linkedinValueKeywordsFound: valuePropositionKeywordsFound,
                linkedinValueKeywordsMissing: valuePropositionKeywordsMissing
            };
        }

        // ===== SCORE ATS =====
        function calculateATSScore(profileText, employee, deptName) {
            const text = profileText.toLowerCase();
            const normalizedText = normalizeText(text);
            
            const seniorTitles = ['directeur', 'director', 'head', 'lead', 'responsable', 'manager', 'chief', 'vp', 'associÃ©', 'partner', 'gÃ©rant'];
            const hasSeniorTitle = seniorTitles.some(t => normalizedText.includes(t));
            const titleMatch = employee.position ? 12 : 0;
            const seniorBonus = hasSeniorTitle ? 8 : 0;
            const titleFit = Math.min(20, titleMatch + seniorBonus);
            
            const toolsKeywords = ['salesforce', 'hubspot', 'excel', 'bloomberg', 'reuters', 'power bi', 'sap', 'oracle'];
            const foundTools = toolsKeywords.filter(t => normalizedText.includes(t));
            const toolsFit = Math.min(15, Math.round((foundTools.length / 3) * 15));
            
            const yearsPatterns = [/(\d+)\s*(?:ans?|annÃ©es?)/gi, /(?:depuis)\s*(\d{4})/gi];
            let totalYears = 0;
            yearsPatterns.forEach(pattern => {
                const matches = normalizedText.matchAll(pattern);
                for (const match of matches) {
                    const num = parseInt(match[1]);
                    if (num > 1900 && num < 2030) totalYears = Math.max(totalYears, 2025 - num);
                    else if (num < 50) totalYears = Math.max(totalYears, num);
                }
            });
            
            const progressionKeywords = ['Ã©volution', 'promotion', 'promu', 'devenu', 'nommÃ©'];
            const hasProgression = progressionKeywords.some(p => normalizedText.includes(p));
            const yearsScore = Math.min(10, totalYears >= 10 ? 10 : totalYears >= 5 ? 7 : totalYears >= 2 ? 4 : 2);
            const progressionBonus = hasProgression ? 5 : (hasSeniorTitle ? 3 : 0);
            const seniorityFit = Math.min(15, yearsScore + progressionBonus);
            
            const kpiPatterns = [/[+\-]?\d+(?:[,\.]\d+)?\s*%/g, /\d+(?:[,\.]\d+)?\s*[kKmM]?â‚¬/g, /\d+\s*(?:clients?|comptes?|dossiers?|projets?)/gi, /(?:aum|encours|portefeuille)[\s:]*\d+/gi];
            let kpiCount = 0;
            const kpiMatches = [];
            kpiPatterns.forEach(pattern => {
                const matches = normalizedText.match(pattern) || [];
                kpiCount += matches.length;
                matches.forEach(m => kpiMatches.push(m));
            });
            
            const impactWords = ['augment', 'croissance', 'amÃ©lio', 'rÃ©duit', 'optimis', 'gÃ©nÃ©r', 'atteint', 'dÃ©pass'];
            const hasImpactContext = impactWords.some(w => normalizedText.includes(w));
            const kpiQuality = hasImpactContext ? 1 : (kpiCount > 0 ? 0.5 : 0);
            const impactKPI = Math.min(25, Math.round(5 * Math.log1p(kpiCount) + 15 * kpiQuality));
            
            const recoMatch = normalizedText.match(/(\d+)\s*recommandation/i);
            const recoCount = recoMatch ? parseInt(recoMatch[1]) : 0;
            const certKeywords = ['certifi', 'diplÃ´m', 'master', 'mba', 'cfa', 'amf', 'cgp', 'cif'];
            const certCount = certKeywords.filter(c => normalizedText.includes(c)).length;
            const credibility = Math.min(15, Math.round(Math.min(5, recoCount) + certCount * 1.5 + 2));
            
            const sectorKeywords = ['finance', 'banque', 'patrimoine', 'gestion', 'investissement', 'conseil', 'immobilier'];
            const hasSector = sectorKeywords.some(s => normalizedText.includes(s));
            const contextFit = hasSector ? 10 : 4;
            
            const deptScore = employee.deptScore || 0;
            const keywordFitNormalized = (deptScore / 100) * 20;
            
            const rawScore = 
                (titleFit / 20) * 100 * 0.15 +
                (toolsFit / 15) * 100 * 0.10 +
                (seniorityFit / 15) * 100 * 0.13 +
                (impactKPI / 25) * 100 * 0.25 +
                (credibility / 15) * 100 * 0.15 +
                (contextFit / 10) * 100 * 0.10 +
                (keywordFitNormalized / 20) * 100 * 0.12;
            
            const atsScore = Math.round(rawScore);
            
            let atsDecision;
            if (atsScore >= 80) atsDecision = "ðŸŸ¢ Shortlist";
            else if (atsScore >= 65) atsDecision = "ðŸŸ¡ Ã€ examiner";
            else if (atsScore >= 40) atsDecision = "ðŸŸ  En attente";
            else atsDecision = "ðŸ”´ Non retenu";
            
            return {
                atsScore, atsDecision,
                atsTitleFit: titleFit, atsToolsFit: toolsFit, atsSeniorityFit: seniorityFit,
                atsImpactKPI: impactKPI, atsCredibility: credibility, atsContextFit: contextFit,
                atsFoundTools: foundTools, atsKPICount: kpiCount, atsKPIMatches: kpiMatches.slice(0, 10),
                atsTotalYears: totalYears, atsHasProgression: hasProgression, atsCertCount: certCount, atsRecoCount: recoCount
            };
        }

        // ===== NOUVEAU SCORE MÃ‰TIER PONDÃ‰RÃ‰ =====
        function calculateDeptScore(profileText, deptName) {
            const dept = state.departments.find(d => d.name === deptName);
            if (!dept || !dept.sections) return { 
                score: 0, 
                foundKeywords: [], 
                missingKeywords: [], 
                totalKeywords: 0,
                sectionDetails: [],
                weightedScore: 0,
                rawScore: 0
            };
            
            const normalizedText = normalizeText(profileText);
            
            let totalWeightedPoints = 0;
            let maxWeightedPoints = 0;
            let allFoundKeywords = [];
            let allMissingKeywords = [];
            let sectionDetails = [];
            let totalKeywords = 0;
            
            // Calculer le score pour chaque section
            dept.sections.forEach(section => {
                const foundInSection = [];
                const missingInSection = [];
                
                section.keywords.forEach(keyword => {
                    const normalizedKeyword = normalizeText(keyword);
                    if (normalizedText.includes(normalizedKeyword)) {
                        foundInSection.push(keyword);
                        allFoundKeywords.push({ keyword, section: section.name, weight: section.weight });
                    } else {
                        missingInSection.push(keyword);
                        allMissingKeywords.push({ keyword, section: section.name, weight: section.weight });
                    }
                });
                
                totalKeywords += section.keywords.length;
                
                // Points pondÃ©rÃ©s pour cette section
                const sectionPoints = foundInSection.length * section.weight;
                const sectionMaxPoints = section.keywords.length * section.weight;
                
                totalWeightedPoints += sectionPoints;
                maxWeightedPoints += sectionMaxPoints;
                
                sectionDetails.push({
                    name: section.name,
                    weight: section.weight,
                    found: foundInSection,
                    missing: missingInSection,
                    foundCount: foundInSection.length,
                    totalCount: section.keywords.length,
                    points: sectionPoints,
                    maxPoints: sectionMaxPoints
                });
            });
            
            // Le score est basÃ© sur l'atteinte de 30 mots-clÃ©s pondÃ©rÃ©s
            // On calcule un score pondÃ©rÃ© oÃ¹ chaque mot-clÃ© de section 1 vaut 3, section 2 vaut 2, section 3 vaut 1
            // Le max est 30 mots-clÃ©s * coefficient moyen
            
            // Calcul du score: 100% si >= 30 mots-clÃ©s trouvÃ©s (pondÃ©rÃ©s)
            // On compte les points pondÃ©rÃ©s et on normalise
            const maxTarget = state.metierMaxKeywords; // 30 mots-clÃ©s cible
            
            // Coefficient moyen pondÃ©rÃ© des sections (approximativement 2)
            const avgWeight = 2;
            const targetWeightedPoints = maxTarget * avgWeight; // 60 points pondÃ©rÃ©s pour 100%
            
            // Score final
            const rawScore = Math.min(100, Math.round((totalWeightedPoints / targetWeightedPoints) * 100));
            
            return { 
                score: rawScore,
                foundKeywords: allFoundKeywords.map(k => k.keyword),
                missingKeywords: allMissingKeywords.map(k => k.keyword),
                totalKeywords,
                sectionDetails,
                weightedPoints: totalWeightedPoints,
                maxWeightedPoints: maxWeightedPoints,
                targetPoints: targetWeightedPoints,
                foundCount: allFoundKeywords.length,
                detailedFound: allFoundKeywords,
                detailedMissing: allMissingKeywords
            };
        }

        // ===== EXPORT PDF =====
        function exportToPDF(employee) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Couleurs Cyrus Herez
            const primaryColor = [30, 58, 138]; // Bleu foncÃ©
            const secondaryColor = [59, 130, 246]; // Bleu
            const textColor = [31, 41, 55]; // Gris foncÃ©
            
            let y = 20;
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // En-tÃªte
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('CYRUS HEREZ', margin, 18);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Analyse de Profil LinkedIn', margin, 28);
            doc.text(new Date().toLocaleDateString('fr-FR'), pageWidth - margin - 30, 28);
            
            y = 55;
            
            // Informations du profil
            doc.setTextColor(...textColor);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(`${employee.firstName} ${employee.lastName}`, margin, y);
            y += 8;
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(employee.position || 'Poste non renseignÃ©', margin, y);
            y += 6;
            doc.text(`${employee.department} â€¢ ${employee.company || 'Cyrus Herez'}`, margin, y);
            y += 15;
            
            // Ligne de sÃ©paration
            doc.setDrawColor(...secondaryColor);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 15;
            
            // Scores globaux
            doc.setTextColor(...textColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('SCORES GLOBAUX', margin, y);
            y += 12;
            
            const scores = [
                { label: 'SSI (Social Selling Index)', value: employee.ssiScore || 0, max: 100 },
                { label: 'LinkedIn Pro', value: employee.linkedinGlobalScore || 0, max: 100 },
                { label: 'ADN Cyrus Herez', value: employee.globalScore || 0, max: 100 },
                { label: 'Score MÃ©tier', value: employee.deptScore || 0, max: 100 },
                { label: 'Score ATS', value: employee.atsScore || 0, max: 100 }
            ];
            
            doc.setFontSize(11);
            scores.forEach(s => {
                doc.setFont('helvetica', 'normal');
                doc.text(s.label, margin, y);
                
                // Barre de progression
                const barWidth = 60;
                const barHeight = 6;
                const barX = margin + 80;
                
                // Fond gris
                doc.setFillColor(229, 231, 235);
                doc.rect(barX, y - 5, barWidth, barHeight, 'F');
                
                // Barre colorÃ©e
                const scoreRatio = s.value / s.max;
                let barColor;
                if (scoreRatio >= 0.7) barColor = [34, 197, 94]; // Vert
                else if (scoreRatio >= 0.4) barColor = [234, 179, 8]; // Jaune
                else barColor = [239, 68, 68]; // Rouge
                
                doc.setFillColor(...barColor);
                doc.rect(barX, y - 5, barWidth * scoreRatio, barHeight, 'F');
                
                // Score texte
                doc.setFont('helvetica', 'bold');
                doc.text(`${s.value}/${s.max}`, barX + barWidth + 5, y);
                
                y += 12;
            });
            
            y += 5;
            
            // Statut NO-GO si applicable
            if (employee.linkedinIsNoGo) {
                doc.setFillColor(254, 226, 226);
                doc.rect(margin, y - 5, pageWidth - 2 * margin, 15, 'F');
                doc.setTextColor(185, 28, 28);
                doc.setFont('helvetica', 'bold');
                doc.text('â›” PROFIL NO-GO', margin + 5, y + 5);
                if (employee.linkedinNoGoReasons) {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(employee.linkedinNoGoReasons.join(' | '), margin + 50, y + 5);
                }
                y += 20;
            }
            
            // Ligne de sÃ©paration
            doc.setDrawColor(...secondaryColor);
            doc.line(margin, y, pageWidth - margin, y);
            y += 15;
            
            // DÃ©tail Score MÃ©tier
            doc.setTextColor(...textColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('DETAIL SCORE METIER', margin, y);
            y += 10;
            
            if (employee.deptSectionDetails && employee.deptSectionDetails.length > 0) {
                doc.setFontSize(10);
                employee.deptSectionDetails.forEach(section => {
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primaryColor);
                    doc.text(`${section.name} (x${section.weight})`, margin, y);
                    doc.setTextColor(100, 100, 100);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${section.foundCount}/${section.totalCount} mots-clÃ©s`, margin + 100, y);
                    y += 6;
                    
                    if (section.found.length > 0) {
                        doc.setTextColor(34, 197, 94);
                        const foundText = 'âœ“ ' + section.found.slice(0, 8).join(', ');
                        const splitFound = doc.splitTextToSize(foundText, pageWidth - 2 * margin - 5);
                        doc.text(splitFound, margin + 5, y);
                        y += splitFound.length * 5 + 3;
                    }
                    
                    y += 5;
                });
            }
            
            // Nouvelle page si nÃ©cessaire
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            
            // Mots-clÃ©s ADN trouvÃ©s
            y += 5;
            doc.setTextColor(...textColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('ADN CYRUS HEREZ', margin, y);
            y += 10;
            
            doc.setFontSize(10);
            if (employee.adnFoundGroups && employee.adnFoundGroups.length > 0) {
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(34, 197, 94);
                const foundGroups = employee.adnFoundGroups.map(g => g.name).join(', ');
                const splitGroups = doc.splitTextToSize('âœ“ ' + foundGroups, pageWidth - 2 * margin);
                doc.text(splitGroups, margin, y);
                y += splitGroups.length * 5 + 5;
            }
            
            if (employee.adnMissingGroups && employee.adnMissingGroups.length > 0) {
                doc.setTextColor(239, 68, 68);
                const missingGroups = employee.adnMissingGroups.map(g => g.name).join(', ');
                const splitMissing = doc.splitTextToSize('âœ— ' + missingGroups, pageWidth - 2 * margin);
                doc.text(splitMissing, margin, y);
                y += splitMissing.length * 5 + 5;
            }
            
            // Pied de page
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`GÃ©nÃ©rÃ© le ${new Date().toLocaleString('fr-FR')} â€¢ Analyseur LinkedIn Cyrus Herez v3`, margin, doc.internal.pageSize.getHeight() - 10);
            
            // TÃ©lÃ©charger
            const filename = `profil-linkedin-${employee.firstName}-${employee.lastName}-${Date.now()}.pdf`;
            doc.save(filename);
        }

        // ===== AJOUT RAPIDE =====
        function quickAdd() {
            const text = prompt('ðŸ“‹ Collez le contenu du profil LinkedIn ici (Ctrl+V / Cmd+V) :');
            if (!text || text.length < 50) {
                alert('âŒ Le texte est vide ou trop court. Veuillez copier le profil complet depuis LinkedIn.');
                return;
            }
            const rawLinkedinUrl = prompt('ðŸ”— Collez l\'URL du profil LinkedIn (optionnel) :') || '';
            let linkedinUrl = '';
            if (rawLinkedinUrl.trim() !== '' && isValidLinkedInURL(rawLinkedinUrl.trim())) {
                linkedinUrl = rawLinkedinUrl.trim();
            }
            
            const extracted = extractProfileInfo(text);
            let firstName = extracted.firstName || (linkedinUrl ? extractNameFromLinkedInUrl(linkedinUrl).firstName : '') || 'PrÃ©nom';
            let lastName = extracted.lastName || (linkedinUrl ? extractNameFromLinkedInUrl(linkedinUrl).lastName : '') || 'Nom';
            
            // Auto-dÃ©tection du dÃ©partement
            let autoDept = '', maxScore = 0;
            state.departments.forEach(dept => {
                const deptAnalysis = calculateDeptScore(text, dept.name);
                if (deptAnalysis.score > maxScore) { 
                    maxScore = deptAnalysis.score; 
                    autoDept = dept.name; 
                }
            });
            
            if (!autoDept) autoDept = state.departments[0].name;
            
            const deptAnalysis = calculateDeptScore(text, autoDept);
            const adnAnalysis = analyzeADN(text);
            
            const newEmployee = {
                id: Date.now(), 
                firstName, 
                lastName, 
                position: extracted.position || 'Poste', 
                department: autoDept,
                company: extracted.company || state.targetCompany, 
                linkedinUrl, 
                email: '', 
                profileText: text,
                globalScore: adnAnalysis.globalScore, 
                adnFoundGroups: adnAnalysis.foundGroups,
                adnMissingGroups: adnAnalysis.missingGroups,
                adnTotalGroups: adnAnalysis.totalGroups,
                wordCount: adnAnalysis.wordCount,
                analyzedAt: adnAnalysis.analyzedAt, 
                deptScore: deptAnalysis.score, 
                deptFoundKeywords: deptAnalysis.foundKeywords,
                deptMissingKeywords: deptAnalysis.missingKeywords, 
                deptTotalKeywords: deptAnalysis.totalKeywords,
                deptSectionDetails: deptAnalysis.sectionDetails,
                deptWeightedPoints: deptAnalysis.weightedPoints,
                deptDetailedFound: deptAnalysis.detailedFound,
                createdAt: new Date().toISOString()
            };
            
            Object.assign(newEmployee, calculateLinkedInScore(text, newEmployee), calculateSSI(text, newEmployee));
            Object.assign(newEmployee, calculateATSScore(text, newEmployee, autoDept));
            
            state.employees.push(newEmployee);
            saveState();
            render();
            
            const linkedinInfo = newEmployee.linkedinIsNoGo ? ' â›” NO-GO' : ' ' + newEmployee.linkedinLevel;
            alert('âœ… Profil ajoutÃ© : ' + newEmployee.firstName + ' ' + newEmployee.lastName + 
                '\n\nðŸ“Š Score SSI : ' + newEmployee.ssiScore + '/100' +
                '\nðŸ”µ Score LinkedIn Pro : ' + newEmployee.linkedinGlobalScore + '/100' + linkedinInfo +
                '\nðŸ§¬ Score ADN : ' + newEmployee.globalScore + '/100' +
                '\nðŸ’¼ Score MÃ©tier (' + autoDept + ') : ' + newEmployee.deptScore + '/100 (' + deptAnalysis.foundKeywords.length + ' mots-clÃ©s)' +
                '\nðŸŽ¯ Score ATS : ' + newEmployee.atsScore + '/100 ' + newEmployee.atsDecision);
        }

        function deleteEmployee(id) {
            if (confirm('Supprimer ce collaborateur ?')) {
                state.employees = state.employees.filter(emp => emp.id !== id);
                saveState();
                render();
            }
        }

        function viewEmployee(id) {
            state.selectedEmployee = state.employees.find(emp => emp.id === id);
            state.currentView = 'detail';
            render();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({ employees: state.employees, adnKeywords: state.adnKeywords, departments: state.departments, targetCompany: state.targetCompany }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'linkedin-analyzer-cyrus-' + Date.now() + '.json';
            a.click();
        }

        function clearAllData() {
            if (confirm('âš ï¸ Supprimer TOUTES les donnÃ©es ? Cette action est irrÃ©versible.')) {
                state.employees = [];
                saveState();
                render();
            }
        }

        function getScoreBadge(score) {
            if (score >= 70) return 'bg-green-100 text-green-800';
            if (score >= 40) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function getScoreColor(score) {
            if (score >= 70) return 'text-green-600';
            if (score >= 40) return 'text-yellow-600';
            return 'text-red-600';
        }

        // ===== SYNTHÃˆSES =====
        
        function getSSISynthesis(emp) {
            const score = emp.ssiScore || 0;
            let level, description;
            if (score >= 75) {
                level = "ðŸ† Excellent";
                description = `${emp.firstName} fait partie des meilleurs profils du secteur avec un SSI de ${score}/100.`;
            } else if (score >= 55) {
                level = "âœ… Bon";
                description = `${emp.firstName} a un bon niveau d'activitÃ© sur LinkedIn avec un SSI de ${score}/100.`;
            } else if (score >= 35) {
                level = "âš ï¸ Ã€ dÃ©velopper";
                description = `${emp.firstName} a un SSI de ${score}/100, infÃ©rieur Ã  la moyenne du secteur.`;
            } else {
                level = "ðŸ”´ Faible";
                description = `${emp.firstName} a un SSI de ${score}/100, prÃ©sence LinkedIn Ã  construire.`;
            }
            return { level, description };
        }

        function getADNSynthesis(emp) {
            const score = emp.globalScore || 0;
            let level, description;
            if (score >= 70) {
                level = "ðŸ† Excellent alignement";
                description = `Le profil reflÃ¨te parfaitement l'ADN Cyrus Herez avec ${emp.adnFoundGroups?.length || 0}/${emp.adnTotalGroups || 14} thÃ©matiques couvertes.`;
            } else if (score >= 50) {
                level = "âœ… Bon alignement";
                description = `${emp.firstName} couvre ${emp.adnFoundGroups?.length || 0}/${emp.adnTotalGroups || 14} thÃ©matiques. Quelques ajustements renforceraient l'alignement.`;
            } else if (score >= 30) {
                level = "âš ï¸ Alignement partiel";
                description = `Seulement ${emp.adnFoundGroups?.length || 0}/${emp.adnTotalGroups || 14} thÃ©matiques prÃ©sentes. Un travail sur le vocabulaire est conseillÃ©.`;
            } else {
                level = "ðŸ”´ Faible alignement";
                description = `Le profil ne reflÃ¨te pas l'ADN Cyrus Herez (${emp.adnFoundGroups?.length || 0}/${emp.adnTotalGroups || 14} thÃ©matiques).`;
            }
            return { level, description };
        }

        // ===== RENDU =====

        function renderHeader() {
            return `<header class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 shadow-lg">
                <div class="max-w-7xl mx-auto px-4 py-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-white">ðŸ›ï¸ Analyseur LinkedIn - Cyrus Herez</h1>
                            <p class="text-sm text-blue-200 mt-1">Alignement des profils avec l'ADN de l'entreprise â€¢ v3</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportData()" class="p-2 text-white hover:bg-blue-700 rounded-lg transition" title="Exporter JSON">ðŸ“¥</button>
                            <button onclick="clearAllData()" class="p-2 text-white hover:bg-red-600 rounded-lg transition" title="Tout supprimer">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            </header>`;
        }

        function renderEmployeeList() {
            const avgScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.globalScore || 0), 0) / state.employees.length) : 0;
            const avgLinkedInScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.linkedinGlobalScore || 0), 0) / state.employees.length) : 0;
            const avgSSIScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.ssiScore || 0), 0) / state.employees.length) : 0;
            const avgATSScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.atsScore || 0), 0) / state.employees.length) : 0;
            const avgMetierScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.deptScore || 0), 0) / state.employees.length) : 0;
            const noGoCount = state.employees.filter(e => e.linkedinIsNoGo).length;
            
            let html = `<div class="space-y-4">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200 shadow-sm">
                    <h3 class="text-lg font-bold text-blue-900 mb-2">ðŸ›ï¸ Cyrus Herez - Gestion Patrimoniale</h3>
                    <p class="text-sm text-blue-800 mb-3">${state.companyMission}</p>
                    <div class="bg-white/60 p-3 rounded-lg mt-3">
                        <p class="text-xs font-semibold text-blue-700 mb-2">ðŸ“‹ Score MÃ©tier : basÃ© sur 3 sections pondÃ©rÃ©es (max sur ${state.metierMaxKeywords} mots-clÃ©s)</p>
                        <div class="flex flex-wrap gap-1 text-xs">
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded">Section 1 (x3) : CÅ“ur de mÃ©tier</span>
                            <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded">Section 2 (x2) : Expertise</span>
                            <span class="px-2 py-0.5 bg-gray-100 text-gray-700 rounded">Section 3 (x1) : ComplÃ©mentaire</span>
                        </div>
                    </div>
                </div>`;
            
            if (state.employees.length > 0) {
                html += `<div class="grid grid-cols-7 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-blue-600">${state.employees.length}</p><p class="text-xs text-gray-600 mt-1">Profils</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-purple-600">${avgSSIScore}</p><p class="text-xs text-gray-600 mt-1">SSI</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-cyan-600">${avgLinkedInScore}</p><p class="text-xs text-gray-600 mt-1">LinkedIn Pro</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-green-600">${avgScore}</p><p class="text-xs text-gray-600 mt-1">ADN</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-indigo-600">${avgMetierScore}</p><p class="text-xs text-gray-600 mt-1">MÃ©tier</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-amber-600">${avgATSScore}</p><p class="text-xs text-gray-600 mt-1">ATS</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border ${noGoCount > 0 ? 'bg-red-50 border-red-200' : ''}"><p class="text-2xl font-bold ${noGoCount > 0 ? 'text-red-600' : 'text-gray-400'}">${noGoCount}</p><p class="text-xs text-gray-600 mt-1">No-Go</p></div>
                </div>`;
            }
            
            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="quickAdd()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white py-5 rounded-xl hover:from-blue-700 hover:to-blue-800 shadow-lg transition transform hover:scale-[1.02]">
                    <div class="font-bold text-lg">âš¡ Coller le texte</div>
                    <div class="text-sm opacity-90 mt-1">Copier-coller le profil LinkedIn</div>
                </button>
                <button onclick="state.currentView = 'add'; render();" class="bg-white border-2 border-gray-300 text-gray-700 py-5 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition">
                    <div class="font-bold text-lg">âž• Saisie manuelle</div>
                    <div class="text-sm text-gray-500 mt-1">Formulaire complet</div>
                </button>
            </div>`;
            
            html += '<div class="grid gap-4">';
            state.employees.forEach(emp => {
                const linkedinNoGoBadge = emp.linkedinIsNoGo ? '<span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700 font-medium">â›” NO-GO</span>' : '';
                const cyrusHerezBadge = emp.linkedinHasCyrusHerez ? '<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700">âœ“ Cyrus Herez</span>' : '<span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">âš ï¸ Sans Cyrus Herez</span>';
                
                html += `<div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-all border ${emp.linkedinIsNoGo ? 'border-l-4 border-l-red-500' : 'border-gray-100'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <h3 class="text-lg font-bold text-gray-900">${emp.firstName} ${emp.lastName}</h3>
                                ${linkedinNoGoBadge}
                                ${cyrusHerezBadge}
                            </div>
                            <p class="text-gray-600">${emp.position}</p>
                            <div class="flex gap-2 mt-2 text-sm">
                                <span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded font-medium">${emp.department}</span>
                                ${emp.company ? '<span class="text-gray-400">â€¢</span><span class="text-gray-500">' + emp.company + '</span>' : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.ssiScore || 0)}">${emp.ssiScore || 0}</div><p class="text-xs text-gray-500 mt-1">SSI</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.linkedinGlobalScore || 0)}">${emp.linkedinGlobalScore || 0}</div><p class="text-xs text-gray-500 mt-1">Pro</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.globalScore || 0)}">${emp.globalScore || 0}</div><p class="text-xs text-gray-500 mt-1">ADN</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.deptScore || 0)}">${emp.deptScore || 0}</div><p class="text-xs text-gray-500 mt-1">MÃ©tier</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.atsScore || 0)}">${emp.atsScore || 0}</div><p class="text-xs text-gray-500 mt-1">ATS</p></div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                        <button onclick="viewEmployee(${emp.id})" class="flex-1 px-4 py-2.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-medium transition">ðŸ“Š Voir la fiche</button>
                        <button onclick="exportToPDF(state.employees.find(e => e.id === ${emp.id}))" class="px-4 py-2.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 font-medium transition">ðŸ“„ PDF</button>
                        ${emp.linkedinUrl && isValidLinkedInURL(emp.linkedinUrl) ? '<a href="' + emp.linkedinUrl + '" target="_blank" class="px-4 py-2.5 text-blue-600 hover:bg-blue-50 rounded-lg transition">ðŸ”—</a>' : ''}
                        <button onclick="deleteEmployee(${emp.id})" class="px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition">ðŸ—‘ï¸</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            if (state.employees.length === 0) {
                html += `<div class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                    <div class="text-6xl mb-4">ðŸ“Š</div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun profil analysÃ©</h3>
                    <p class="text-gray-600 mb-6">Commencez par ajouter un profil LinkedIn</p>
                </div>`;
            }
            
            html += '</div>';
            return html;
        }

        function renderEmployeeDetail() {
            const emp = state.selectedEmployee;
            if (!emp) return '';
            
            const ssiSynthesis = getSSISynthesis(emp);
            const adnSynthesis = getADNSynthesis(emp);
            
            let html = `<div class="space-y-6">
                <div class="flex justify-between items-center">
                    <button onclick="state.currentView = 'list'; render();" class="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2">
                        <span>â†</span> Retour Ã  la liste
                    </button>
                    <button onclick="exportToPDF(state.selectedEmployee)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition flex items-center gap-2">
                        ðŸ“„ Exporter en PDF
                    </button>
                </div>
                
                <!-- En-tÃªte du profil -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-3xl font-bold text-gray-900">${emp.firstName} ${emp.lastName}</h2>
                                ${emp.linkedinIsNoGo ? '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">â›” NO-GO</span>' : ''}
                                ${emp.linkedinHasCyrusHerez ? '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">âœ“ Cyrus Herez dans le titre</span>' : '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">âš ï¸ Cyrus Herez absent du titre</span>'}
                            </div>
                            <p class="text-lg text-gray-600">${emp.position}</p>
                            <p class="text-gray-500">${emp.department} â€¢ ${emp.company}</p>
                        </div>
                        <button onclick="deleteEmployee(${emp.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Supprimer">ðŸ—‘ï¸</button>
                    </div>
                    ${emp.linkedinUrl ? '<a href="' + emp.linkedinUrl + '" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:underline text-sm bg-blue-50 px-4 py-2 rounded-full">ðŸ”— Voir le profil LinkedIn</a>' : ''}
                </div>
                
                <!-- Scores globaux -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="text-lg font-bold mb-4">ðŸ† Scores globaux</h3>
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center p-4 bg-purple-50 rounded-xl">
                            <p class="text-sm text-purple-700 font-medium mb-2">ðŸ“Š SSI</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.ssiScore || 0)}">${emp.ssiScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                        </div>
                        <div class="text-center p-4 bg-cyan-50 rounded-xl">
                            <p class="text-sm text-cyan-700 font-medium mb-2">ðŸ”µ LinkedIn Pro</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.linkedinGlobalScore || 0)}">${emp.linkedinGlobalScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                            <p class="text-xs mt-1 ${emp.linkedinIsNoGo ? 'text-red-600 font-bold' : 'text-gray-500'}">${emp.linkedinLevel || ''}</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <p class="text-sm text-green-700 font-medium mb-2">ðŸ§¬ ADN</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.globalScore || 0)}">${emp.globalScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                        </div>
                        <div class="text-center p-4 bg-indigo-50 rounded-xl">
                            <p class="text-sm text-indigo-700 font-medium mb-2">ðŸ’¼ MÃ©tier</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.deptScore || 0)}">${emp.deptScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                            <p class="text-xs mt-1 text-gray-500">${emp.deptFoundKeywords?.length || 0} mots-clÃ©s</p>
                        </div>
                        <div class="text-center p-4 bg-amber-50 rounded-xl">
                            <p class="text-sm text-amber-700 font-medium mb-2">ðŸŽ¯ ATS</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.atsScore || 0)}">${emp.atsScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                            <p class="text-xs mt-1 ${(emp.atsScore || 0) >= 65 ? 'text-green-600' : 'text-orange-600'}">${emp.atsDecision || ''}</p>
                        </div>
                    </div>
                </div>`;
            
            // Section Score MÃ©tier dÃ©taillÃ©
            html += `<div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-xl border border-indigo-200">
                <h3 class="text-lg font-bold mb-4 text-indigo-900">ðŸ’¼ Score MÃ©tier - ${emp.department}</h3>
                <div class="bg-white p-4 rounded-lg mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-medium">Score global</span>
                        <span class="text-2xl font-bold ${getScoreColor(emp.deptScore || 0)}">${emp.deptScore || 0}/100</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">ðŸ“Œ BasÃ© sur ${emp.deptFoundKeywords?.length || 0} mots-clÃ©s trouvÃ©s (max sur ${state.metierMaxKeywords} mots-clÃ©s pondÃ©rÃ©s)</p>
                    <p class="text-xs text-gray-500">Points pondÃ©rÃ©s: ${emp.deptWeightedPoints || 0} / objectif ${state.metierMaxKeywords * 2}</p>
                </div>`;
            
            // DÃ©tail par section
            if (emp.deptSectionDetails && emp.deptSectionDetails.length > 0) {
                emp.deptSectionDetails.forEach(section => {
                    const sectionColor = section.weight === 3 ? 'green' : (section.weight === 2 ? 'yellow' : 'gray');
                    html += `<div class="bg-white p-4 rounded-lg mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 bg-${sectionColor}-100 text-${sectionColor}-700 rounded text-xs font-bold">x${section.weight}</span>
                                <span class="font-medium text-gray-800">${section.name}</span>
                            </div>
                            <span class="font-bold ${section.foundCount >= section.totalCount / 2 ? 'text-green-600' : 'text-orange-600'}">${section.foundCount}/${section.totalCount}</span>
                        </div>
                        ${section.found.length > 0 ? '<div class="flex flex-wrap gap-1 mb-2">' + section.found.map(k => '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">âœ“ ' + k + '</span>').join('') + '</div>' : ''}
                        ${section.missing.length > 0 ? '<details class="text-sm"><summary class="cursor-pointer text-gray-500 hover:text-gray-700">Voir les ' + section.missing.length + ' mots-clÃ©s manquants</summary><div class="flex flex-wrap gap-1 mt-2">' + section.missing.slice(0, 10).map(k => '<span class="px-2 py-0.5 bg-gray-100 text-gray-500 rounded text-xs">' + k + '</span>').join('') + (section.missing.length > 10 ? '<span class="text-xs text-gray-400">+' + (section.missing.length - 10) + ' autres</span>' : '') + '</div></details>' : ''}
                    </div>`;
                });
            }
            html += '</div>';
            
            // SSI Section
            html += `<div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-xl border border-purple-200">
                <h3 class="text-lg font-bold mb-4 text-purple-900">ðŸ“Š Social Selling Index (SSI)</h3>
                <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${(emp.ssiScore || 0) >= 55 ? 'border-green-500' : (emp.ssiScore || 0) >= 35 ? 'border-yellow-500' : 'border-red-500'}">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">${ssiSynthesis.level}</span>
                        <span class="text-2xl font-bold ${getScoreColor(emp.ssiScore || 0)}">${emp.ssiScore || 0}/100</span>
                    </div>
                    <p class="text-gray-600">${ssiSynthesis.description}</p>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-white p-3 rounded-lg text-center">
                        <p class="text-xs text-gray-500 mb-1">Marque pro</p>
                        <p class="text-lg font-bold ${getScoreColor((emp.ssiBrandScore || 0) * 4)}">${emp.ssiBrandScore || 0}/25</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg text-center">
                        <p class="text-xs text-gray-500 mb-1">RÃ©seau</p>
                        <p class="text-lg font-bold ${getScoreColor((emp.ssiPeopleScore || 0) * 4)}">${emp.ssiPeopleScore || 0}/25</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg text-center">
                        <p class="text-xs text-gray-500 mb-1">Ã‰change</p>
                        <p class="text-lg font-bold ${getScoreColor((emp.ssiEngagementScore || 0) * 4)}">${emp.ssiEngagementScore || 0}/25</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg text-center">
                        <p class="text-xs text-gray-500 mb-1">Relations</p>
                        <p class="text-lg font-bold ${getScoreColor((emp.ssiRelationScore || 0) * 4)}">${emp.ssiRelationScore || 0}/25</p>
                    </div>
                </div>
            </div>`;
            
            // ADN Section
            html += `<div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200">
                <h3 class="text-lg font-bold mb-4 text-green-900">ðŸ§¬ ADN Cyrus Herez</h3>
                <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${(emp.globalScore || 0) >= 50 ? 'border-green-500' : 'border-orange-500'}">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">${adnSynthesis.level}</span>
                        <span class="text-2xl font-bold ${getScoreColor(emp.globalScore || 0)}">${emp.globalScore || 0}/100</span>
                    </div>
                    <p class="text-gray-600">${adnSynthesis.description}</p>
                </div>
                ${emp.adnFoundGroups && emp.adnFoundGroups.length > 0 ? '<div class="mb-3"><p class="text-sm font-medium text-green-700 mb-2">âœ“ ThÃ©matiques prÃ©sentes :</p><div class="flex flex-wrap gap-2">' + emp.adnFoundGroups.map(g => '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">' + g.name + '</span>').join('') + '</div></div>' : ''}
                ${emp.adnMissingGroups && emp.adnMissingGroups.length > 0 ? '<div><p class="text-sm font-medium text-orange-700 mb-2">âœ— ThÃ©matiques Ã  ajouter :</p><div class="flex flex-wrap gap-2">' + emp.adnMissingGroups.map(g => '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">' + g.name + '</span>').join('') + '</div></div>' : ''}
            </div>`;
            
            html += '</div>';
            return html;
        }

        function renderAddForm() {
            let deptOptions = '<option value="">SÃ©lectionner...</option>';
            state.departments.forEach(d => {
                deptOptions += `<option value="${d.name}">${d.name}</option>`;
            });
            
            return `<div class="bg-white p-8 rounded-xl shadow-sm max-w-3xl mx-auto border">
                <h2 class="text-2xl font-bold mb-6">âž• Ajouter un collaborateur</h2>
                <form onsubmit="handleAddEmployee(event); return false;" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">PrÃ©nom *</label><input type="text" id="firstName" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label><input type="text" id="lastName" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Poste</label><input type="text" id="position" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Service</label><select id="department" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${deptOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Entreprise</label><input type="text" id="company" value="${state.targetCompany}" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ðŸ“§ Email</label><input type="email" id="email" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ðŸ”— URL LinkedIn</label><input type="url" id="linkedinUrl" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Profil LinkedIn (texte) *</label><textarea id="profileText" required class="w-full px-4 py-3 border rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Collez le contenu du profil LinkedIn..."></textarea></div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-lg hover:bg-blue-700 font-medium transition">âœ… Ajouter</button>
                        <button type="button" onclick="state.currentView = 'list'; render();" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 font-medium transition">âŒ Annuler</button>
                    </div>
                </form>
            </div>`;
        }

        function handleAddEmployee(event) {
            event.preventDefault();
            const profileText = document.getElementById('profileText').value;
            const linkedinUrl = document.getElementById('linkedinUrl')?.value || '';
            const email = document.getElementById('email')?.value || '';
            const department = document.getElementById('department').value || state.departments[0].name;
            
            if (linkedinUrl && !isValidLinkedInURL(linkedinUrl)) { alert('âš ï¸ URL LinkedIn invalide'); return; }
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('âš ï¸ Email invalide'); return; }
            
            const adnAnalysis = analyzeADN(profileText);
            const deptAnalysis = calculateDeptScore(profileText, department);
            
            const newEmployee = {
                id: Date.now(), 
                firstName: document.getElementById('firstName').value, 
                lastName: document.getElementById('lastName').value,
                position: document.getElementById('position').value, 
                department, 
                company: document.getElementById('company').value,
                email, 
                linkedinUrl, 
                profileText, 
                globalScore: adnAnalysis.globalScore, 
                adnFoundGroups: adnAnalysis.foundGroups,
                adnMissingGroups: adnAnalysis.missingGroups,
                adnTotalGroups: adnAnalysis.totalGroups,
                wordCount: adnAnalysis.wordCount,
                analyzedAt: adnAnalysis.analyzedAt, 
                deptScore: deptAnalysis.score,
                deptFoundKeywords: deptAnalysis.foundKeywords, 
                deptMissingKeywords: deptAnalysis.missingKeywords,
                deptTotalKeywords: deptAnalysis.totalKeywords,
                deptSectionDetails: deptAnalysis.sectionDetails,
                deptWeightedPoints: deptAnalysis.weightedPoints,
                deptDetailedFound: deptAnalysis.detailedFound,
                createdAt: new Date().toISOString()
            };
            
            Object.assign(newEmployee, calculateLinkedInScore(profileText, newEmployee), calculateSSI(profileText, newEmployee));
            Object.assign(newEmployee, calculateATSScore(profileText, newEmployee, department));
            
            state.employees.push(newEmployee);
            saveState();
            state.currentView = 'list';
            render();
            alert('âœ… Profil ajoutÃ© avec succÃ¨s !');
        }

        function render() {
            const app = document.getElementById('app');
            let content = '';
            if (state.currentView === 'list') content = renderEmployeeList();
            else if (state.currentView === 'detail') content = renderEmployeeDetail();
            else if (state.currentView === 'add') content = renderAddForm();
            app.innerHTML = renderHeader() + '<main class="max-w-7xl mx-auto px-4 py-6">' + content + '</main>';
        }

        loadState();
        render();
    </script>
</body>
</html>

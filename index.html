<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur LinkedIn - ADN de Marque Cyrus Herez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .progress-bar { height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 6px; transition: width 0.3s ease; }
        .progress-gradient-green { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .progress-gradient-yellow { background: linear-gradient(90deg, #eab308, #ca8a04); }
        .progress-gradient-orange { background: linear-gradient(90deg, #f97316, #ea580c); }
        .progress-gradient-red { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .progress-gradient-blue { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .progress-gradient-purple { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // State management
        let state = {
            employees: [],
            adnKeywords: [
                { group: "Gestion de patrimoine", keywords: ["gestion de patrimoine", "gestion de fortune", "gestion priv√©e"] },
                { group: "Accompagnement", keywords: ["accompagnement", "accompagnement patrimonial", "accompagnement clients"] },
                { group: "Structuration", keywords: ["structurer son patrimoine", "structurer votre patrimoine"] },
                { group: "Allocation", keywords: ["allocation d'actifs", "allocation d'actif"] },
                { group: "Strat√©gie", keywords: ["strat√©gie"] },
                { group: "Sur-mesure", keywords: ["sur-mesure", "sur mesure"] },
                { group: "Optimisation", keywords: ["optimiser"] },
                { group: "S√©curisation", keywords: ["s√©curiser"] },
                { group: "Transmission", keywords: ["transmettre"] },
                { group: "Expertise", keywords: ["expertise patrimoniale", "ing√©nierie patrimoniale"] },
                { group: "Gestion financi√®re", keywords: ["gestion financi√®re"] },
                { group: "Immobilier", keywords: ["immobilier", "investissement immobilier"] },
                { group: "Produits structur√©s", keywords: ["produits structur√©s", "produit structur√©"] },
                { group: "Non cot√©", keywords: ["non cot√©", "non-cot√©"] }
            ],
            departments: [
                { 
                    id: 1, 
                    name: "G√©rant Priv√©", 
                    sections: [
                        {
                            name: "Section 1 - C≈ìur de m√©tier",
                            weight: 3,
                            keywords: [
                                "gestion de patrimoine", "gestion priv√©e", "conseil patrimonial", "conseiller patrimonial",
                                "accompagnement patrimonial", "strat√©gie patrimoniale", "optimisation patrimoniale",
                                "transmission patrimoine", "ing√©nierie patrimoniale", "client priv√©", "client√®le priv√©e",
                                "bilan patrimonial", "audit patrimonial", "objectifs patrimoniaux", "planification patrimoniale",
                                "assurance vie", "contrat capitalisation", "allocation d'actifs", "diversification",
                                "√©pargne", "placements"
                            ]
                        },
                        {
                            name: "Section 2 - Expertise dirigeant",
                            weight: 2,
                            keywords: [
                                "transmission d'entreprise", "cession d'entreprise", "cession",
                                "r√©mun√©ration du dirigeant", "optimiser sa r√©mun√©ration", "optimiser sa fiscalit√©",
                                "protection de la famille", "gestion de la tr√©sorerie", "anticiper sa retraite",
                                "transmettre son patrimoine", "succession", "donation", "d√©membrement",
                                "pr√©conisations", "diagnostic", "wealth management"
                            ]
                        },
                        {
                            name: "Section 3 - Classes d'actifs",
                            weight: 1,
                            keywords: [
                                "classe d'actif", "produit structur√©", "produits structur√©s", "non cot√©", "non-cot√©",
                                "dette priv√©e", "infrastructure", "private equity", "fond d'investissement",
                                "fonds d'investissement", "scpi", "allocation de scpi", "r√©sidentiel", "r√©sidentielle",
                                "compte titres", "performance", "gestion de fortune"
                            ]
                        }
                    ]
                },
                { 
                    id: 2, 
                    name: "G√©rant de Fortune", 
                    sections: [
                        {
                            name: "Section 1 - C≈ìur de m√©tier",
                            weight: 3,
                            keywords: [
                                "gestion de fortune", "gestion priv√©e", "gestion financi√®re", "gestion actifs",
                                "gestion portefeuille", "portfolio management", "asset management",
                                "g√©rant", "g√©rante", "fund manager", "allocation d'actifs", "asset allocation",
                                "performance financi√®re", "portefeuille", "portefeuilles", "analyse financi√®re",
                                "march√©s financiers", "investissement", "investissements", "valorisation",
                                "gestion de patrimoine"
                            ]
                        },
                        {
                            name: "Section 2 - Expertise technique",
                            weight: 2,
                            keywords: [
                                "risque", "gestion risque", "risk management", "volatilit√©", "rendement",
                                "obligations", "actions", "pricing", "analyste financier", "analyste",
                                "finance de march√©", "transmission", "transmission d'entreprise", "optimisation",
                                "diversification", "classe d'actif", "produit structur√©", "produits structur√©s"
                            ]
                        },
                        {
                            name: "Section 3 - Actifs alternatifs",
                            weight: 1,
                            keywords: [
                                "immobilier", "investissement immobilier", "scpi", "opci", "sci", "fonci√®re",
                                "immobilier locatif", "rendement locatif", "actif immobilier", "real estate",
                                "private equity", "capital investissement", "venture capital", "lbo",
                                "dette priv√©e", "private debt", "infrastructure", "fonds alternatifs",
                                "co-investissement", "club deal", "non cot√©", "non-cot√©",
                                "fond d'investissement", "fonds d'investissement"
                            ]
                        }
                    ]
                }
            ],
            targetCompany: 'Cyrus Herez',
            currentView: 'list',
            selectedEmployee: null,
            companyMission: "Cyrus Herez accompagne les dirigeants, entrepreneurs et familles dans la construction, la s√©curisation et la transmission de leur patrimoine gr√¢ce √† une approche globale int√©grant conseil strat√©gique, ing√©nierie patrimoniale, allocation financi√®re, immobilier et investissements alternatifs.",
            metierMaxKeywords: 30,
        };

        // ===== FONCTIONS UTILITAIRES =====

        function loadState() {
            try {
                const saved = localStorage.getItem('employees_v4');
                if (saved) state.employees = JSON.parse(saved);
            } catch (e) {
                console.error('Error loading state:', e);
            }
        }

        function saveState() {
            localStorage.setItem('employees_v4', JSON.stringify(state.employees));
        }

        function processText(text) {
            return text.toLowerCase()
                .replace(/[^\w\s√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ø√¶≈ì√ß'-]/gi, ' ')
                .split(/\s+/)
                .filter(word => word.length > 2);
        }

        function normalizeText(text) {
            return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function extractLinkedInUsername(url) {
            if (!url) return '';
            const match = url.match(/linkedin\.com\/in\/([^\/\?]+)/);
            return match ? match[1] : '';
        }

        function isValidLinkedInURL(url) {
            return /linkedin\.com\/in\/[^\/\?]+/.test(url);
        }

        function extractProfileInfo(text) {
            const lines = text.split('\n').filter(l => l.trim());
            let firstName = '', lastName = '', position = '', company = '';
            
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].trim();
                const nameMatch = line.match(/^([A-Z√Ä-√ø][a-z√†-√ø]+(?:\s+[A-Z√Ä-√ø][a-z√†-√ø]+){0,2})\s*$/);
                if (nameMatch && line.length < 40) {
                    const parts = nameMatch[1].split(/\s+/);
                    if (parts.length >= 2) {
                        firstName = parts[0];
                        lastName = parts.slice(1).join(' ');
                        break;
                    }
                }
            }
            
            const positionKeywords = ['manager', 'director', 'ceo', 'cto', 'cfo', 'developer', 'engineer', 'consultant', 'analyst', 'specialist', 'coordinator', 'lead', 'head', 'chef', 'responsable', 'directeur', 'directrice', 'g√©rant', 'associ√©', 'partner', 'founder', 'fondateur', 'conseiller', 'banquier'];
            for (const line of lines) {
                const lowerLine = line.toLowerCase();
                if (positionKeywords.some(keyword => lowerLine.includes(keyword))) {
                    position = line.trim();
                    break;
                }
            }
            
            for (const line of lines) {
                if (line.toLowerCase().includes('chez ') || line.toLowerCase().includes(' at ') || line.toLowerCase().includes('cyrus')) {
                    company = line.replace(/chez |at /gi, '').trim();
                    break;
                }
            }
            
            return { firstName, lastName, position, company };
        }

        function capitalizeWord(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function extractNameFromLinkedInUrl(url) {
            const username = extractLinkedInUsername(url);
            if (!username) return { firstName: '', lastName: '' };
            let slug = decodeURIComponent(username).toLowerCase().replace(/\d+/g, '').replace(/_/g, '-').replace(/\s+/g, '-');
            const parts = slug.split('-').filter(Boolean);
            if (parts.length === 0) return { firstName: '', lastName: '' };
            if (parts.length === 1) return { firstName: capitalizeWord(parts[0]), lastName: '' };
            if (parts.length === 2) return { firstName: capitalizeWord(parts[0]), lastName: capitalizeWord(parts[1]) };
            return { firstName: parts.slice(0, -1).map(capitalizeWord).join(' '), lastName: capitalizeWord(parts[parts.length - 1]) };
        }

        function getProgressGradient(score, max = 100) {
            const ratio = score / max;
            if (ratio >= 0.7) return 'progress-gradient-green';
            if (ratio >= 0.5) return 'progress-gradient-yellow';
            if (ratio >= 0.3) return 'progress-gradient-orange';
            return 'progress-gradient-red';
        }

        function getScoreEmoji(score) {
            if (score >= 80) return 'üèÜ';
            if (score >= 60) return '‚úÖ';
            if (score >= 40) return '‚ö†Ô∏è';
            return 'üî¥';
        }

        // ===== NOUVEAU CALCUL ADN CYRUS HEREZ =====
        function analyzeADN(profileText) {
            const normalizedText = normalizeText(profileText);
            const wordCount = processText(profileText).length;
            
            let foundGroups = [];
            let missingGroups = [];
            let totalGroups = state.adnKeywords.length;
            
            state.adnKeywords.forEach(group => {
                const normalizedKeywords = group.keywords.map(k => normalizeText(k));
                const found = normalizedKeywords.some(kw => normalizedText.includes(kw));
                const foundKeyword = group.keywords.find(kw => normalizedText.includes(normalizeText(kw)));
                
                if (found) {
                    foundGroups.push({ name: group.group, keyword: foundKeyword });
                } else {
                    missingGroups.push({ name: group.group, suggestions: group.keywords.slice(0, 2) });
                }
            });
            
            const globalScore = Math.round((foundGroups.length / totalGroups) * 100);
            
            return { 
                globalScore, 
                foundGroups, 
                missingGroups, 
                totalGroups,
                wordCount, 
                analyzedAt: new Date().toISOString() 
            };
        }

        // ===== SCORE SSI =====
        function calculateSSI(profileText, employee) {
            const text = profileText.toLowerCase();
            const words = processText(profileText);
            const wordCount = words.length;
            
            // 1. Marque professionnelle (25 pts)
            let brandScore = 0;
            let brandDetails = { hasName: false, hasPosition: false, hasContent: false, hasExpertise: false };
            if (employee.firstName && employee.lastName) { brandScore += 5; brandDetails.hasName = true; }
            if (employee.position) { brandScore += 5; brandDetails.hasPosition = true; }
            if (wordCount >= 200) { brandScore += 10; brandDetails.hasContent = true; }
            else if (wordCount >= 100) { brandScore += 5; brandDetails.hasContent = true; }
            if (text.includes('expert') || text.includes('sp√©cialiste') || text.includes('passion')) { brandScore += 5; brandDetails.hasExpertise = true; }
            
            // 2. Trouver les bonnes personnes (25 pts)
            const networkKeywords = ['r√©seau', 'network', 'professionnel', 'contact', 'relation', 'partenaire', 'collaboration'];
            const foundNetworkKeywords = networkKeywords.filter(k => text.includes(k));
            const peopleScore = Math.min(25, foundNetworkKeywords.length * 4);
            
            // 3. √âchanger des informations (25 pts)
            const engageKeywords = ['partage', 'publication', 'article', 'insight', 'analyse', 'expertise', 'conseil', 'contribution'];
            const foundEngageKeywords = engageKeywords.filter(k => text.includes(k));
            const engagementScore = Math.min(25, foundEngageKeywords.length * 3.5);
            
            // 4. √âtablir des relations (25 pts)
            const relationKeywords = ['accompagnement', '√©coute', 'client', 'confiance', 'long-terme', 'long terme', 'fid√©lit√©', 'suivi', 'proximit√©', 'partenariat', 'relation durable', 'sur-mesure', 'personnalis√©'];
            const foundRelationKeywords = relationKeywords.filter(k => text.includes(k));
            const relationScore = Math.min(25, foundRelationKeywords.length * 3);
            
            const ssiScore = Math.round(brandScore + peopleScore + engagementScore + relationScore);
            
            // Classements
            let sectorRanking = 50, networkRanking = 50;
            if (ssiScore >= 75) { sectorRanking = 10; networkRanking = 15; }
            else if (ssiScore >= 60) { sectorRanking = 20; networkRanking = 24; }
            else if (ssiScore >= 45) { sectorRanking = 35; networkRanking = 40; }
            else if (ssiScore >= 30) { sectorRanking = 50; networkRanking = 55; }
            
            // Points forts et √† am√©liorer
            const ssiStrengths = [];
            const ssiWeaknesses = [];
            
            if (brandScore >= 20) ssiStrengths.push({ icon: 'üèÜ', label: 'Marque professionnelle' });
            else ssiWeaknesses.push({ icon: 'üèÜ', label: 'Marque professionnelle', priority: brandScore < 10 ? 'haute' : 'moyenne' });
            
            if (peopleScore >= 15) ssiStrengths.push({ icon: 'üë•', label: 'Trouver les bonnes personnes' });
            else ssiWeaknesses.push({ icon: 'üë•', label: 'Trouver les bonnes personnes', priority: peopleScore < 8 ? 'haute' : 'moyenne' });
            
            if (engagementScore >= 15) ssiStrengths.push({ icon: 'üí¨', label: '√âchanger des informations' });
            else ssiWeaknesses.push({ icon: 'üí¨', label: '√âchanger des informations', priority: engagementScore < 8 ? 'haute' : 'moyenne' });
            
            if (relationScore >= 15) ssiStrengths.push({ icon: 'ü§ù', label: '√âtablir des relations' });
            else ssiWeaknesses.push({ icon: 'ü§ù', label: '√âtablir des relations', priority: relationScore < 8 ? 'haute' : 'moyenne' });
            
            return { 
                ssiScore, 
                ssiBrandScore: Math.round(brandScore), 
                ssiPeopleScore: Math.round(peopleScore), 
                ssiEngagementScore: Math.round(engagementScore), 
                ssiRelationScore: Math.round(relationScore), 
                ssiSectorRanking: sectorRanking, 
                ssiNetworkRanking: networkRanking, 
                ssiAvgSectorScore: 32, 
                ssiAvgNetworkScore: 36,
                ssiRelationKeywordsFound: foundRelationKeywords,
                ssiNetworkKeywordsFound: foundNetworkKeywords,
                ssiEngageKeywordsFound: foundEngageKeywords,
                ssiStrengths,
                ssiWeaknesses,
                ssiBrandDetails: brandDetails
            };
        }

        // ===== SCORE LINKEDIN PRO =====
        function calculateLinkedInScore(profileText, employee) {
            const text = profileText.toLowerCase();
            const normalizedText = normalizeText(text);
            const wordCount = processText(profileText).length;
            
            // 1. IDENTIT√â & CR√âDIBILIT√â (15 pts)
            let photoScore = 0;
            const photoIndicators = ['photo', 'image', 'profil', 'portrait'];
            const hasPhotoMention = photoIndicators.some(p => text.includes(p));
            if (hasPhotoMention || wordCount > 150) photoScore = 3;
            else if (wordCount > 80) photoScore = 2;
            
            let bannerScore = 0;
            const bannerIndicators = ['banni√®re', 'banner', 'arri√®re-plan', 'background', 'couverture'];
            const hasBannerMention = bannerIndicators.some(b => text.includes(b));
            if (hasBannerMention) bannerScore = 2;
            else if (wordCount > 200) bannerScore = 1;
            
            let headlineScore = 0;
            const hasCyrusHerez = text.includes('cyrus herez') || text.includes('cyrus-herez');
            const positionKeywords = ['g√©rant', 'conseiller', 'directeur', 'manager', 'responsable', 'associ√©', 'partner', 'expert', 'consultant'];
            const hasPositionTitle = positionKeywords.some(k => normalizedText.includes(k));
            
            if (hasCyrusHerez && hasPositionTitle) headlineScore = 5;
            else if (hasCyrusHerez) headlineScore = 4;
            else if (hasPositionTitle && employee.position) headlineScore = 2;
            else if (employee.position) headlineScore = 1;
            
            const locationKeywords = ['paris', 'lyon', 'marseille', 'bordeaux', 'nantes', 'toulouse', 'lille', 'france', 'r√©gion', '√Æle-de-france'];
            const hasLocation = locationKeywords.some(l => normalizedText.includes(l));
            const hasCurrentJob = text.includes('actuel') || text.includes('current') || text.includes('pr√©sent') || text.includes('depuis');
            const locationScore = (hasLocation ? 3 : 0) + (hasCurrentJob ? 2 : 0);
            
            const identityScore = photoScore + bannerScore + headlineScore + locationScore;
            
            // 2. PROPOSITION DE VALEUR (20 pts)
            let valuePropositionKeywordsFound = [];
            let valuePropositionKeywordsMissing = [];
            
            state.adnKeywords.forEach(group => {
                const normalizedKeywords = group.keywords.map(k => normalizeText(k));
                const found = normalizedKeywords.some(kw => normalizedText.includes(kw));
                const foundKeyword = group.keywords.find(kw => normalizedText.includes(normalizeText(kw)));
                
                if (found) {
                    valuePropositionKeywordsFound.push({ group: group.group, keyword: foundKeyword });
                } else {
                    valuePropositionKeywordsMissing.push(group.group);
                }
            });
            
            const valueRatio = valuePropositionKeywordsFound.length / state.adnKeywords.length;
            let summaryScore = Math.round(valueRatio * 10);
            
            const hasNumbers = /\d+/.test(text);
            const hasResults = ['r√©sultat', 'impact', 'r√©alis', 'atteint', 'd√©velopp', 'augment', 'r√©duit', 'optimis', 'am√©lio', 'g√©n√©r√©'].some(r => normalizedText.includes(r));
            if (hasNumbers && hasResults) summaryScore = Math.min(10, summaryScore + 2);
            
            let coherenceScore = 0;
            const deptKeywordsFound = employee.deptFoundKeywords?.length || 0;
            const deptTotal = employee.deptTotalKeywords || 1;
            const coherenceRatio = deptKeywordsFound / deptTotal;
            
            if (coherenceRatio >= 0.25) coherenceScore = 10;
            else if (coherenceRatio >= 0.15) coherenceScore = 7;
            else if (coherenceRatio >= 0.08) coherenceScore = 5;
            else coherenceScore = 2;
            
            const positioningScore = summaryScore + coherenceScore;
            
            // 3. EXP√âRIENCE (25 pts)
            let experienceDetailScore = 0;
            const expKeywords = ['exp√©rience', 'experience', 'poste', 'mission', 'responsab', 'projet', '√©quipe', 'manage', 'pilote', 'd√©velopp'];
            const hasExpDetail = expKeywords.filter(k => normalizedText.includes(k)).length;
            const hasMetrics = /(\d+\s*%|\d+\s*[kKmM]?‚Ç¨|\d+\s*clients?|\d+\s*personnes?|\d+\s*projets?)/.test(text);
            const hasImpact = ['augment', 'r√©duit', 'cr√©√©', 'lanc√©', 'n√©goci', 'sign√©', 'g√©n√©r√©', 'optimis'].some(i => normalizedText.includes(i));
            
            if (hasExpDetail >= 4 && hasMetrics && hasImpact) experienceDetailScore = 15;
            else if (hasExpDetail >= 3 && (hasMetrics || hasImpact)) experienceDetailScore = 12;
            else if (hasExpDetail >= 2 && hasMetrics) experienceDetailScore = 10;
            else if (hasExpDetail >= 2) experienceDetailScore = 8;
            else if (hasExpDetail >= 1) experienceDetailScore = 5;
            else experienceDetailScore = 3;
            
            let progressionScore = 0;
            const seniorityTerms = ['junior', 'confirm√©', 'senior', 'lead', 'manager', 'head', 'directeur', 'vp', 'chief', 'partner', 'associ√©'];
            const progressionTerms = ['promu', '√©volution', 'progression', 'nomm√©', 'devenu', 'promotion'];
            const yearsPattern = /(\d+)\s*ans?/g;
            const yearsMatches = [...normalizedText.matchAll(yearsPattern)];
            const hasLongExp = yearsMatches.some(m => parseInt(m[1]) >= 5);
            const hasSeniority = seniorityTerms.filter(s => normalizedText.includes(s)).length >= 2;
            const hasProgression = progressionTerms.some(p => normalizedText.includes(p));
            
            if (hasProgression && hasSeniority) progressionScore = 10;
            else if (hasLongExp && hasSeniority) progressionScore = 8;
            else if (hasSeniority || hasLongExp) progressionScore = 6;
            else if (hasProgression) progressionScore = 5;
            else progressionScore = 3;
            
            const experienceScore = experienceDetailScore + progressionScore;
            
            // 4. COMP√âTENCES (20 pts)
            let skillsScore = 0;
            const skillsKeywords = ['comp√©tence', 'skill', 'expertise', 'ma√Ætrise', 'connaissance', 'savoir-faire', 'sp√©cialit√©'];
            const toolsFound = employee.atsFoundTools?.length || 0;
            const hasSkillsSection = skillsKeywords.some(s => normalizedText.includes(s));
            
            if (toolsFound >= 5 && hasSkillsSection) skillsScore = 10;
            else if (toolsFound >= 3 || (hasSkillsSection && deptKeywordsFound >= 5)) skillsScore = 8;
            else if (toolsFound >= 1 || deptKeywordsFound >= 3) skillsScore = 6;
            else if (hasSkillsSection) skillsScore = 4;
            else skillsScore = 2;
            
            let validationScore = 0;
            const recoMatch = normalizedText.match(/(\d+)\s*recommandation/i);
            const recoCount = recoMatch ? parseInt(recoMatch[1]) : 0;
            const endorsementKeywords = ['valid√©', 'endorsed', 'recommand', 't√©moign', 'r√©f√©rence'];
            const hasEndorsements = endorsementKeywords.some(e => normalizedText.includes(e));
            
            if (recoCount >= 5 && hasEndorsements) validationScore = 10;
            else if (recoCount >= 3 || hasEndorsements) validationScore = 7;
            else if (recoCount >= 1) validationScore = 5;
            
            const competenceScore = skillsScore + validationScore;
            
            // 5. ENGAGEMENT (10 pts)
            let activityScore = 0;
            const activityKeywords = ['publication', 'article', 'post', 'partag', '√©crit', 'publi', 'auteur', 'contributeur'];
            const foundActivityKeywords = activityKeywords.filter(a => normalizedText.includes(a));
            
            if (foundActivityKeywords.length >= 3) activityScore = 5;
            else if (foundActivityKeywords.length >= 1) activityScore = 3;
            
            let networkScore = 0;
            const extractNumber = (text, patterns) => {
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const numStr = match[1].replace(/[\s\u00A0\.]/g, '').replace(',', '');
                        return parseInt(numStr) || 0;
                    }
                }
                return 0;
            };
            
            const followerPatterns = [/([\d\s\u00A0.,]+)\s*abonn[√©e]s?/i, /([\d\s\u00A0.,]+)\s*followers?/i];
            const connexionPatterns = [/([\d\s\u00A0.,]+)\s*(?:relations?|connexions?|contacts?)/i, /plus de\s*([\d\s\u00A0.,]+)\s*(?:relations?|connexions?)/i];
            
            const followersCount = extractNumber(text, followerPatterns);
            const connexionsCount = extractNumber(text, connexionPatterns);
            const networkCount = Math.max(followersCount, connexionsCount);
            
            if (networkCount >= 10000) networkScore = 5;
            else if (networkCount >= 500 || text.includes('plus de 500')) networkScore = 5;
            else if (networkCount >= 200) networkScore = 4;
            else if (networkCount >= 100) networkScore = 3;
            else if (networkCount > 0) networkScore = 2;
            else networkScore = 1;
            
            const engagementScore = activityScore + networkScore;
            
            // 6. FORMATION (10 pts)
            let educationScore = 0;
            const educationKeywords = ['dipl√¥me', 'master', 'licence', 'bachelor', 'ing√©nieur', '√©cole', 'universit√©', 'bac+', 'formation', 'mba', 'doctorat', 'phd'];
            const prestigeSchools = ['hec', 'essec', 'escp', 'edhec', 'polytechnique', 'centrale', 'mines', 'dauphine', 'sciences po', 'insead', 'em lyon'];
            const hasEducation = educationKeywords.filter(e => normalizedText.includes(e)).length;
            const hasPrestige = prestigeSchools.some(s => normalizedText.includes(s));
            
            if (hasPrestige) educationScore = 5;
            else if (hasEducation >= 2) educationScore = 5;
            else if (hasEducation >= 1) educationScore = 3;
            
            let certScore = 0;
            const certKeywords = ['certifi', 'certified', 'certification', 'accr√©dit√©', 'agr√©√©', 'habilit√©', 'cfa', 'amf', 'cgp', 'cif', 'iobsp'];
            const hasCerts = certKeywords.filter(c => normalizedText.includes(c)).length;
            
            if (hasCerts >= 3) certScore = 5;
            else if (hasCerts >= 1) certScore = 4;
            
            const formationScore = educationScore + certScore;
            
            // SCORE TOTAL
            const linkedinGlobalScore = Math.min(100, identityScore + positioningScore + experienceScore + competenceScore + engagementScore + formationScore);
            
            // R√àGLES NO-GO
            const noGoReasons = [];
            if (!hasCyrusHerez) noGoReasons.push("'Cyrus Herez' absent du titre");
            if (experienceDetailScore < 5) noGoReasons.push("Exp√©riences non d√©taill√©es");
            if (headlineScore < 2) noGoReasons.push("Titre non professionnel");
            if (valuePropositionKeywordsFound.length < 3) noGoReasons.push("Proposition de valeur incompl√®te");
            if (wordCount < 50) noGoReasons.push("Profil trop succinct");
            
            const isNoGo = noGoReasons.length >= 2;
            const finalScore = isNoGo ? Math.min(29, linkedinGlobalScore) : linkedinGlobalScore;
            
            let linkedinLevel, linkedinVerdict;
            if (isNoGo) {
                linkedinLevel = "üî¥ Non pertinent";
                linkedinVerdict = "Profil √©limin√© (r√®gles No-Go)";
            } else if (finalScore >= 85) {
                linkedinLevel = "üèÜ Expert";
                linkedinVerdict = "Profil hautement pertinent";
            } else if (finalScore >= 70) {
                linkedinLevel = "‚úÖ Solide";
                linkedinVerdict = "Profil solide et exploitable";
            } else if (finalScore >= 50) {
                linkedinLevel = "‚ö†Ô∏è Moyen";
                linkedinVerdict = "Profil √† approfondir";
            } else if (finalScore >= 30) {
                linkedinLevel = "üü† Faible";
                linkedinVerdict = "Profil peu diff√©renciant";
            } else {
                linkedinLevel = "üî¥ Insuffisant";
                linkedinVerdict = "Profil non pertinent";
            }
            
            // Points forts LinkedIn Pro
            const linkedinStrengths = [];
            const linkedinWeaknesses = [];
            
            if (identityScore >= 10) linkedinStrengths.push({ icon: 'üÜî', label: 'Identit√© & Cr√©dibilit√©' });
            else linkedinWeaknesses.push({ icon: 'üÜî', label: 'Identit√© & Cr√©dibilit√©', tips: ['Ajouter Cyrus Herez au titre', 'Compl√©ter la localisation'] });
            
            if (positioningScore >= 14) linkedinStrengths.push({ icon: 'üéØ', label: 'Proposition de valeur' });
            else linkedinWeaknesses.push({ icon: 'üéØ', label: 'Proposition de valeur', tips: ['Enrichir le r√©sum√© avec les mots-cl√©s ADN', 'Ajouter des r√©sultats chiffr√©s'] });
            
            if (experienceScore >= 18) linkedinStrengths.push({ icon: 'üíº', label: 'Exp√©rience professionnelle' });
            else linkedinWeaknesses.push({ icon: 'üíº', label: 'Exp√©rience professionnelle', tips: ['D√©tailler les missions avec des m√©triques', 'Montrer la progression de carri√®re'] });
            
            if (competenceScore >= 14) linkedinStrengths.push({ icon: '‚≠ê', label: 'Comp√©tences & Expertise' });
            else linkedinWeaknesses.push({ icon: '‚≠ê', label: 'Comp√©tences & Expertise', tips: ['Ajouter des comp√©tences cl√©s', 'Obtenir des recommandations'] });
            
            if (engagementScore >= 7) linkedinStrengths.push({ icon: 'üì¢', label: 'Engagement & Visibilit√©' });
            else linkedinWeaknesses.push({ icon: 'üì¢', label: 'Engagement & Visibilit√©', tips: ['Publier du contenu r√©guli√®rement', 'D√©velopper son r√©seau'] });
            
            if (formationScore >= 7) linkedinStrengths.push({ icon: 'üéì', label: 'Formation & Acad√©mique' });
            else linkedinWeaknesses.push({ icon: 'üéì', label: 'Formation & Acad√©mique', tips: ['Ajouter les certifications', 'Compl√©ter le parcours acad√©mique'] });
            
            return { 
                linkedinGlobalScore: finalScore,
                linkedinLevel,
                linkedinVerdict,
                linkedinIsNoGo: isNoGo,
                linkedinNoGoReasons: noGoReasons,
                linkedinIdentityScore: identityScore,
                linkedinPhotoScore: photoScore,
                linkedinBannerScore: bannerScore,
                linkedinHeadlineScore: headlineScore,
                linkedinHasCyrusHerez: hasCyrusHerez,
                linkedinLocationScore: locationScore,
                linkedinPositioningScore: positioningScore,
                linkedinSummaryScore: summaryScore,
                linkedinCoherenceScore: coherenceScore,
                linkedinExperienceScore: experienceScore,
                linkedinExpDetailScore: experienceDetailScore,
                linkedinProgressionScore: progressionScore,
                linkedinCompetenceScore: competenceScore,
                linkedinSkillsScore: skillsScore,
                linkedinValidationScore: validationScore,
                linkedinEngagementScore: engagementScore,
                linkedinActivityScore: activityScore,
                linkedinNetworkScore: networkScore,
                linkedinFormationScore: formationScore,
                linkedinEducationScore: educationScore,
                linkedinCertScore: certScore,
                linkedinFollowersCount: followersCount,
                linkedinConnexionsCount: connexionsCount,
                linkedinValueKeywordsFound: valuePropositionKeywordsFound,
                linkedinValueKeywordsMissing: valuePropositionKeywordsMissing,
                linkedinStrengths,
                linkedinWeaknesses
            };
        }

        // ===== SCORE ATS =====
        function calculateATSScore(profileText, employee, deptName) {
            const text = profileText.toLowerCase();
            const normalizedText = normalizeText(text);
            
            const seniorTitles = ['directeur', 'director', 'head', 'lead', 'responsable', 'manager', 'chief', 'vp', 'associ√©', 'partner', 'g√©rant'];
            const hasSeniorTitle = seniorTitles.some(t => normalizedText.includes(t));
            const titleMatch = employee.position ? 12 : 0;
            const seniorBonus = hasSeniorTitle ? 8 : 0;
            const titleFit = Math.min(20, titleMatch + seniorBonus);
            
            const toolsKeywords = ['salesforce', 'hubspot', 'excel', 'bloomberg', 'reuters', 'power bi', 'sap', 'oracle'];
            const foundTools = toolsKeywords.filter(t => normalizedText.includes(t));
            const toolsFit = Math.min(15, Math.round((foundTools.length / 3) * 15));
            
            const yearsPatterns = [/(\d+)\s*(?:ans?|ann√©es?)/gi, /(?:depuis)\s*(\d{4})/gi];
            let totalYears = 0;
            yearsPatterns.forEach(pattern => {
                const matches = normalizedText.matchAll(pattern);
                for (const match of matches) {
                    const num = parseInt(match[1]);
                    if (num > 1900 && num < 2030) totalYears = Math.max(totalYears, 2025 - num);
                    else if (num < 50) totalYears = Math.max(totalYears, num);
                }
            });
            
            const progressionKeywords = ['√©volution', 'promotion', 'promu', 'devenu', 'nomm√©'];
            const hasProgression = progressionKeywords.some(p => normalizedText.includes(p));
            const yearsScore = Math.min(10, totalYears >= 10 ? 10 : totalYears >= 5 ? 7 : totalYears >= 2 ? 4 : 2);
            const progressionBonus = hasProgression ? 5 : (hasSeniorTitle ? 3 : 0);
            const seniorityFit = Math.min(15, yearsScore + progressionBonus);
            
            const kpiPatterns = [/[+\-]?\d+(?:[,\.]\d+)?\s*%/g, /\d+(?:[,\.]\d+)?\s*[kKmM]?‚Ç¨/g, /\d+\s*(?:clients?|comptes?|dossiers?|projets?)/gi, /(?:aum|encours|portefeuille)[\s:]*\d+/gi];
            let kpiCount = 0;
            const kpiMatches = [];
            kpiPatterns.forEach(pattern => {
                const matches = normalizedText.match(pattern) || [];
                kpiCount += matches.length;
                matches.forEach(m => kpiMatches.push(m));
            });
            
            const impactWords = ['augment', 'croissance', 'am√©lio', 'r√©duit', 'optimis', 'g√©n√©r', 'atteint', 'd√©pass'];
            const hasImpactContext = impactWords.some(w => normalizedText.includes(w));
            const kpiQuality = hasImpactContext ? 1 : (kpiCount > 0 ? 0.5 : 0);
            const impactKPI = Math.min(25, Math.round(5 * Math.log1p(kpiCount) + 15 * kpiQuality));
            
            const recoMatch = normalizedText.match(/(\d+)\s*recommandation/i);
            const recoCount = recoMatch ? parseInt(recoMatch[1]) : 0;
            const certKeywords = ['certifi', 'dipl√¥m', 'master', 'mba', 'cfa', 'amf', 'cgp', 'cif'];
            const certCount = certKeywords.filter(c => normalizedText.includes(c)).length;
            const credibility = Math.min(15, Math.round(Math.min(5, recoCount) + certCount * 1.5 + 2));
            
            const sectorKeywords = ['finance', 'banque', 'patrimoine', 'gestion', 'investissement', 'conseil', 'immobilier'];
            const hasSector = sectorKeywords.some(s => normalizedText.includes(s));
            const contextFit = hasSector ? 10 : 4;
            
            const deptScore = employee.deptScore || 0;
            const keywordFitNormalized = (deptScore / 100) * 20;
            
            const rawScore = 
                (titleFit / 20) * 100 * 0.15 +
                (toolsFit / 15) * 100 * 0.10 +
                (seniorityFit / 15) * 100 * 0.13 +
                (impactKPI / 25) * 100 * 0.25 +
                (credibility / 15) * 100 * 0.15 +
                (contextFit / 10) * 100 * 0.10 +
                (keywordFitNormalized / 20) * 100 * 0.12;
            
            const atsScore = Math.round(rawScore);
            
            let atsDecision;
            if (atsScore >= 80) atsDecision = "üü¢ Shortlist";
            else if (atsScore >= 65) atsDecision = "üü° √Ä examiner";
            else if (atsScore >= 40) atsDecision = "üü† En attente";
            else atsDecision = "üî¥ Non retenu";
            
            return {
                atsScore, atsDecision,
                atsTitleFit: titleFit, atsToolsFit: toolsFit, atsSeniorityFit: seniorityFit,
                atsImpactKPI: impactKPI, atsCredibility: credibility, atsContextFit: contextFit,
                atsFoundTools: foundTools, atsKPICount: kpiCount, atsKPIMatches: kpiMatches.slice(0, 10),
                atsTotalYears: totalYears, atsHasProgression: hasProgression, atsCertCount: certCount, atsRecoCount: recoCount
            };
        }

        // ===== SCORE M√âTIER POND√âR√â =====
        function calculateDeptScore(profileText, deptName) {
            const dept = state.departments.find(d => d.name === deptName);
            if (!dept || !dept.sections) return { 
                score: 0, foundKeywords: [], missingKeywords: [], totalKeywords: 0,
                sectionDetails: [], weightedScore: 0, rawScore: 0
            };
            
            const normalizedText = normalizeText(profileText);
            
            let totalWeightedPoints = 0;
            let maxWeightedPoints = 0;
            let allFoundKeywords = [];
            let allMissingKeywords = [];
            let sectionDetails = [];
            let totalKeywords = 0;
            
            dept.sections.forEach(section => {
                const foundInSection = [];
                const missingInSection = [];
                
                section.keywords.forEach(keyword => {
                    const normalizedKeyword = normalizeText(keyword);
                    if (normalizedText.includes(normalizedKeyword)) {
                        foundInSection.push(keyword);
                        allFoundKeywords.push({ keyword, section: section.name, weight: section.weight });
                    } else {
                        missingInSection.push(keyword);
                        allMissingKeywords.push({ keyword, section: section.name, weight: section.weight });
                    }
                });
                
                totalKeywords += section.keywords.length;
                
                const sectionPoints = foundInSection.length * section.weight;
                const sectionMaxPoints = section.keywords.length * section.weight;
                
                totalWeightedPoints += sectionPoints;
                maxWeightedPoints += sectionMaxPoints;
                
                sectionDetails.push({
                    name: section.name,
                    weight: section.weight,
                    found: foundInSection,
                    missing: missingInSection,
                    foundCount: foundInSection.length,
                    totalCount: section.keywords.length,
                    points: sectionPoints,
                    maxPoints: sectionMaxPoints
                });
            });
            
            const maxTarget = state.metierMaxKeywords;
            const avgWeight = 2;
            const targetWeightedPoints = maxTarget * avgWeight;
            
            const rawScore = Math.min(100, Math.round((totalWeightedPoints / targetWeightedPoints) * 100));
            
            return { 
                score: rawScore,
                foundKeywords: allFoundKeywords.map(k => k.keyword),
                missingKeywords: allMissingKeywords.map(k => k.keyword),
                totalKeywords,
                sectionDetails,
                weightedPoints: totalWeightedPoints,
                maxWeightedPoints: maxWeightedPoints,
                targetPoints: targetWeightedPoints,
                foundCount: allFoundKeywords.length,
                detailedFound: allFoundKeywords,
                detailedMissing: allMissingKeywords
            };
        }

        // ===== PR√âCONISATIONS =====
        function generateRecommendations(employee) {
            const recommendations = {
                ssi: [],
                linkedin: [],
                adn: [],
                metier: []
            };
            
            // SSI Recommendations
            if (employee.ssiBrandScore < 20) {
                recommendations.ssi.push({
                    priority: 'haute',
                    icon: 'üèÜ',
                    title: 'Am√©liorer la marque professionnelle',
                    actions: [
                        'Enrichir le r√©sum√© avec plus de 200 mots',
                        'Mettre en avant votre expertise et sp√©cialit√©s',
                        'Ajouter des mots-cl√©s comme "expert", "sp√©cialiste"'
                    ]
                });
            }
            if (employee.ssiPeopleScore < 15) {
                recommendations.ssi.push({
                    priority: 'moyenne',
                    icon: 'üë•',
                    title: 'D√©velopper le r√©seau',
                    actions: [
                        'Mentionner vos collaborations et partenariats',
                        'Utiliser les termes : r√©seau, professionnel, partenaire',
                        'D√©crire vos interactions avec les contacts cl√©s'
                    ]
                });
            }
            if (employee.ssiEngagementScore < 15) {
                recommendations.ssi.push({
                    priority: 'moyenne',
                    icon: 'üí¨',
                    title: '√âchanger des informations',
                    actions: [
                        'Publier des articles et analyses',
                        'Partager votre expertise et insights',
                        'Contribuer aux discussions du secteur'
                    ]
                });
            }
            if (employee.ssiRelationScore < 15) {
                recommendations.ssi.push({
                    priority: 'haute',
                    icon: 'ü§ù',
                    title: 'Construire des relations',
                    actions: [
                        'Utiliser InMail pour les prospects strat√©giques',
                        'Organiser ou participer √† des LinkedIn Live',
                        'Cr√©er des sondages pour engager son audience',
                        'Mettre en avant l\'accompagnement client'
                    ]
                });
            }
            
            // LinkedIn Pro Recommendations
            if (!employee.linkedinHasCyrusHerez) {
                recommendations.linkedin.push({
                    priority: 'haute',
                    icon: 'üÜî',
                    title: 'Ajouter Cyrus Herez au titre',
                    actions: [
                        'Modifier le titre pour inclure "Cyrus Herez"',
                        'Format recommand√© : "Poste | Cyrus Herez"'
                    ]
                });
            }
            if (employee.linkedinExperienceScore < 18) {
                recommendations.linkedin.push({
                    priority: 'moyenne',
                    icon: 'üíº',
                    title: 'D√©tailler les exp√©riences',
                    actions: [
                        'Ajouter des m√©triques (%, ‚Ç¨, clients)',
                        'D√©crire les missions et responsabilit√©s',
                        'Montrer l\'√©volution de carri√®re'
                    ]
                });
            }
            if (employee.linkedinCompetenceScore < 14) {
                recommendations.linkedin.push({
                    priority: 'moyenne',
                    icon: '‚≠ê',
                    title: 'Renforcer les comp√©tences',
                    actions: [
                        'Ajouter les comp√©tences cl√©s du m√©tier',
                        'Obtenir des recommandations de clients/coll√®gues',
                        'Valider les comp√©tences techniques'
                    ]
                });
            }
            
            // ADN Recommendations
            if (employee.adnMissingGroups && employee.adnMissingGroups.length > 0) {
                const missingGroups = employee.adnMissingGroups.slice(0, 5);
                recommendations.adn.push({
                    priority: employee.globalScore < 50 ? 'haute' : 'moyenne',
                    icon: 'üß¨',
                    title: 'Enrichir le vocabulaire ADN',
                    actions: missingGroups.map(g => `Ajouter des termes li√©s √† "${g.name}" : ${g.suggestions.join(', ')}`)
                });
            }
            
            // M√©tier Recommendations
            if (employee.deptSectionDetails) {
                employee.deptSectionDetails.forEach(section => {
                    if (section.foundCount < section.totalCount / 2) {
                        const priority = section.weight === 3 ? 'haute' : (section.weight === 2 ? 'moyenne' : 'basse');
                        recommendations.metier.push({
                            priority,
                            icon: section.weight === 3 ? 'üéØ' : (section.weight === 2 ? 'üìà' : 'üìä'),
                            title: `Compl√©ter ${section.name}`,
                            actions: section.missing.slice(0, 4).map(k => `Ajouter "${k}"`)
                        });
                    }
                });
            }
            
            return recommendations;
        }

        // ===== EXPORT PDF =====
        async function exportToPDF(employee) {
            // Afficher le loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pdf-loading';
            loadingDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            loadingDiv.innerHTML = '<div class="bg-white p-6 rounded-xl shadow-xl"><div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-3"></div><p class="text-gray-700">G√©n√©ration du PDF...</p></div>';
            document.body.appendChild(loadingDiv);
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - 2 * margin;
                
                let y = margin;
                
                // Couleurs
                const colors = {
                    primary: [30, 58, 138],
                    secondary: [59, 130, 246],
                    green: [34, 197, 94],
                    yellow: [234, 179, 8],
                    orange: [249, 115, 22],
                    red: [239, 68, 68],
                    purple: [139, 92, 246],
                    gray: [107, 114, 128],
                    lightGray: [229, 231, 235],
                    text: [31, 41, 55]
                };
                
                // Fonctions utilitaires PDF
                const addNewPageIfNeeded = (neededHeight) => {
                    if (y + neededHeight > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                        return true;
                    }
                    return false;
                };
                
                const drawProgressBar = (x, y, width, height, value, max, color) => {
                    // Fond
                    doc.setFillColor(...colors.lightGray);
                    doc.roundedRect(x, y, width, height, 2, 2, 'F');
                    // Barre
                    const fillWidth = (value / max) * width;
                    doc.setFillColor(...color);
                    doc.roundedRect(x, y, fillWidth, height, 2, 2, 'F');
                };
                
                const getScoreColor = (score) => {
                    if (score >= 70) return colors.green;
                    if (score >= 50) return colors.yellow;
                    if (score >= 30) return colors.orange;
                    return colors.red;
                };
                
                // ===== EN-T√äTE =====
                doc.setFillColor(...colors.primary);
                doc.rect(0, 0, pageWidth, 35, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('CYRUS HEREZ', margin, 15);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Analyse de Profil LinkedIn', margin, 22);
                doc.text(new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' }), pageWidth - margin, 22, { align: 'right' });
                
                y = 45;
                
                // ===== INFOS PROFIL =====
                doc.setTextColor(...colors.text);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${employee.firstName} ${employee.lastName}`, margin, y);
                
                if (employee.linkedinIsNoGo) {
                    doc.setFillColor(254, 226, 226);
                    doc.roundedRect(margin + 80, y - 5, 25, 7, 2, 2, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...colors.red);
                    doc.text('NO-GO', margin + 83, y);
                }
                
                y += 6;
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colors.gray);
                doc.text(employee.position || 'Poste non renseign√©', margin, y);
                y += 5;
                doc.text(`${employee.department} ‚Ä¢ ${employee.company || 'Cyrus Herez'}`, margin, y);
                y += 10;
                
                // ===== SCORES GLOBAUX =====
                doc.setFillColor(248, 250, 252);
                doc.roundedRect(margin, y, contentWidth, 25, 3, 3, 'F');
                
                doc.setTextColor(...colors.text);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Scores globaux', margin + 5, y + 6);
                
                const scores = [
                    { label: 'SSI', value: employee.ssiScore || 0, icon: 'üìä' },
                    { label: 'LinkedIn Pro', value: employee.linkedinGlobalScore || 0, icon: 'üîµ' },
                    { label: 'ADN', value: employee.globalScore || 0, icon: 'üß¨' },
                    { label: 'M√©tier', value: employee.deptScore || 0, icon: 'üíº' },
                    { label: 'ATS', value: employee.atsScore || 0, icon: 'üéØ' }
                ];
                
                const scoreWidth = contentWidth / 5;
                scores.forEach((s, i) => {
                    const x = margin + i * scoreWidth;
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...getScoreColor(s.value));
                    doc.text(`${s.value}`, x + scoreWidth/2, y + 16, { align: 'center' });
                    doc.setFontSize(7);
                    doc.setTextColor(...colors.gray);
                    doc.text(`${s.label}`, x + scoreWidth/2, y + 21, { align: 'center' });
                });
                
                y += 32;
                
                // ===== SSI SECTION =====
                doc.setFillColor(245, 243, 255);
                doc.roundedRect(margin, y, contentWidth, 55, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.purple);
                doc.text('Social Selling Index (SSI)', margin + 5, y + 7);
                
                // Score et niveau
                const ssiLevel = employee.ssiScore >= 75 ? 'Excellent' : employee.ssiScore >= 55 ? 'Bon' : employee.ssiScore >= 35 ? '√Ä d√©velopper' : 'Faible';
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...getScoreColor(employee.ssiScore || 0));
                doc.text(`${getScoreEmoji(employee.ssiScore || 0)} ${ssiLevel} ${employee.ssiScore || 0}/100`, margin + 5, y + 14);
                
                // Classements
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colors.gray);
                doc.text(`Classement Secteur: Top ${employee.ssiSectorRanking}%`, margin + 5, y + 20);
                doc.text(`Classement R√©seau: Top ${employee.ssiNetworkRanking}%`, margin + 70, y + 20);
                
                // Barres de progression SSI
                const ssiFactors = [
                    { label: 'Marque professionnelle', value: employee.ssiBrandScore || 0, max: 25 },
                    { label: 'Trouver les bonnes personnes', value: employee.ssiPeopleScore || 0, max: 25 },
                    { label: '√âchanger des informations', value: employee.ssiEngagementScore || 0, max: 25 },
                    { label: '√âtablir des relations', value: employee.ssiRelationScore || 0, max: 25 }
                ];
                
                let barY = y + 26;
                ssiFactors.forEach((factor, i) => {
                    doc.setFontSize(7);
                    doc.setTextColor(...colors.text);
                    doc.text(factor.label, margin + 5, barY + 3);
                    
                    drawProgressBar(margin + 55, barY, 90, 5, factor.value, factor.max, getScoreColor((factor.value/factor.max)*100));
                    
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...getScoreColor((factor.value/factor.max)*100));
                    doc.text(`${factor.value}/${factor.max}`, margin + 148, barY + 3);
                    
                    barY += 7;
                });
                
                y += 60;
                
                // ===== LINKEDIN PRO SECTION =====
                addNewPageIfNeeded(50);
                
                doc.setFillColor(236, 254, 255);
                doc.roundedRect(margin, y, contentWidth, 45, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.secondary);
                doc.text('√âvaluation LinkedIn Pro', margin + 5, y + 7);
                
                // Score et verdict
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...getScoreColor(employee.linkedinGlobalScore || 0));
                doc.text(`${employee.linkedinGlobalScore || 0}/100`, margin + 5, y + 14);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colors.text);
                doc.text(`${employee.linkedinLevel || ''} - ${employee.linkedinVerdict || ''}`, margin + 25, y + 14);
                
                // Points forts
                if (employee.linkedinStrengths && employee.linkedinStrengths.length > 0) {
                    doc.setFontSize(7);
                    doc.setTextColor(...colors.green);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Points forts : ', margin + 5, y + 22);
                    doc.setFont('helvetica', 'normal');
                    const strengthsText = employee.linkedinStrengths.map(s => s.label).join(', ');
                    doc.text(strengthsText, margin + 28, y + 22);
                }
                
                // √Ä am√©liorer
                if (employee.linkedinWeaknesses && employee.linkedinWeaknesses.length > 0) {
                    doc.setFontSize(7);
                    doc.setTextColor(...colors.orange);
                    doc.setFont('helvetica', 'bold');
                    doc.text('√Ä am√©liorer : ', margin + 5, y + 28);
                    doc.setFont('helvetica', 'normal');
                    const weaknessesText = employee.linkedinWeaknesses.map(s => s.label).join(', ');
                    doc.text(weaknessesText, margin + 28, y + 28);
                }
                
                // Barres LinkedIn Pro
                const linkedinFactors = [
                    { label: 'Identit√©', value: employee.linkedinIdentityScore || 0, max: 15 },
                    { label: 'Valeur', value: employee.linkedinPositioningScore || 0, max: 20 },
                    { label: 'Exp√©rience', value: employee.linkedinExperienceScore || 0, max: 25 },
                    { label: 'Comp√©tences', value: employee.linkedinCompetenceScore || 0, max: 20 },
                    { label: 'Engagement', value: employee.linkedinEngagementScore || 0, max: 10 },
                    { label: 'Formation', value: employee.linkedinFormationScore || 0, max: 10 }
                ];
                
                const factorWidth = contentWidth / 6;
                linkedinFactors.forEach((factor, i) => {
                    const x = margin + i * factorWidth;
                    doc.setFontSize(6);
                    doc.setTextColor(...colors.gray);
                    doc.text(factor.label, x + factorWidth/2, y + 36, { align: 'center' });
                    
                    drawProgressBar(x + 2, y + 38, factorWidth - 4, 3, factor.value, factor.max, getScoreColor((factor.value/factor.max)*100));
                    
                    doc.setFontSize(6);
                    doc.setTextColor(...getScoreColor((factor.value/factor.max)*100));
                    doc.text(`${factor.value}/${factor.max}`, x + factorWidth/2, y + 44, { align: 'center' });
                });
                
                y += 50;
                
                // ===== ADN SECTION =====
                addNewPageIfNeeded(35);
                
                doc.setFillColor(240, 253, 244);
                doc.roundedRect(margin, y, contentWidth, 30, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.green);
                doc.text('ADN Cyrus Herez', margin + 5, y + 7);
                
                doc.setFontSize(9);
                doc.setTextColor(...getScoreColor(employee.globalScore || 0));
                doc.text(`${employee.globalScore || 0}/100 - ${employee.adnFoundGroups?.length || 0}/${employee.adnTotalGroups || 14} th√©matiques`, margin + 5, y + 14);
                
                // Th√©matiques
                if (employee.adnFoundGroups && employee.adnFoundGroups.length > 0) {
                    doc.setFontSize(6);
                    doc.setTextColor(...colors.green);
                    const foundText = '‚úì ' + employee.adnFoundGroups.map(g => g.name).join(', ');
                    const splitFound = doc.splitTextToSize(foundText, contentWidth - 10);
                    doc.text(splitFound, margin + 5, y + 20);
                }
                
                if (employee.adnMissingGroups && employee.adnMissingGroups.length > 0) {
                    doc.setFontSize(6);
                    doc.setTextColor(...colors.orange);
                    const missingText = '‚úó ' + employee.adnMissingGroups.map(g => g.name).join(', ');
                    const splitMissing = doc.splitTextToSize(missingText, contentWidth - 10);
                    doc.text(splitMissing, margin + 5, y + 26);
                }
                
                y += 35;
                
                // ===== M√âTIER SECTION =====
                addNewPageIfNeeded(45);
                
                doc.setFillColor(238, 242, 255);
                doc.roundedRect(margin, y, contentWidth, 40, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(79, 70, 229);
                doc.text(`Score M√©tier - ${employee.department}`, margin + 5, y + 7);
                
                doc.setFontSize(9);
                doc.setTextColor(...getScoreColor(employee.deptScore || 0));
                doc.text(`${employee.deptScore || 0}/100 - ${employee.deptFoundKeywords?.length || 0} mots-cl√©s trouv√©s`, margin + 5, y + 14);
                
                // Sections
                if (employee.deptSectionDetails) {
                    let sectionY = y + 20;
                    employee.deptSectionDetails.forEach((section, i) => {
                        const sectionColor = section.weight === 3 ? colors.green : (section.weight === 2 ? colors.yellow : colors.gray);
                        
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...sectionColor);
                        doc.text(`[x${section.weight}] ${section.name.replace('Section 1 - ', '').replace('Section 2 - ', '').replace('Section 3 - ', '')}`, margin + 5, sectionY);
                        
                        drawProgressBar(margin + 55, sectionY - 3, 80, 4, section.foundCount, section.totalCount, sectionColor);
                        
                        doc.setFontSize(7);
                        doc.text(`${section.foundCount}/${section.totalCount}`, margin + 138, sectionY);
                        
                        sectionY += 6;
                    });
                }
                
                y += 45;
                
                // ===== PR√âCONISATIONS =====
                const recommendations = generateRecommendations(employee);
                const allRecs = [...recommendations.ssi, ...recommendations.linkedin, ...recommendations.adn, ...recommendations.metier].filter(r => r.priority === 'haute' || r.priority === 'moyenne');
                
                if (allRecs.length > 0) {
                    addNewPageIfNeeded(50);
                    
                    doc.setFillColor(255, 251, 235);
                    const recHeight = Math.min(60, 15 + allRecs.length * 12);
                    doc.roundedRect(margin, y, contentWidth, recHeight, 3, 3, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colors.orange);
                    doc.text('Plan d\'action - Pr√©conisations', margin + 5, y + 7);
                    
                    let recY = y + 14;
                    allRecs.slice(0, 4).forEach((rec, i) => {
                        const priorityColor = rec.priority === 'haute' ? colors.red : colors.yellow;
                        
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...priorityColor);
                        doc.text(`‚óè ${rec.priority.toUpperCase()}`, margin + 5, recY);
                        
                        doc.setTextColor(...colors.text);
                        doc.text(`${rec.icon} ${rec.title}`, margin + 25, recY);
                        
                        if (rec.actions && rec.actions.length > 0) {
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(6);
                            doc.setTextColor(...colors.gray);
                            doc.text('‚Ä¢ ' + rec.actions[0], margin + 30, recY + 4);
                        }
                        
                        recY += 11;
                    });
                    
                    y += recHeight + 5;
                }
                
                // ===== PIED DE PAGE =====
                doc.setFontSize(7);
                doc.setTextColor(...colors.gray);
                doc.text(`G√©n√©r√© le ${new Date().toLocaleString('fr-FR')} ‚Ä¢ Analyseur LinkedIn Cyrus Herez v4`, margin, pageHeight - 10);
                
                // T√©l√©charger
                const filename = `profil-linkedin-${employee.firstName}-${employee.lastName}-${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(filename);
                
            } catch (error) {
                console.error('Erreur PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF');
            } finally {
                document.getElementById('pdf-loading')?.remove();
            }
        }

        // ===== AJOUT RAPIDE =====
        function quickAdd() {
            const text = prompt('üìã Collez le contenu du profil LinkedIn ici (Ctrl+V / Cmd+V) :');
            if (!text || text.length < 50) {
                alert('‚ùå Le texte est vide ou trop court. Veuillez copier le profil complet depuis LinkedIn.');
                return;
            }
            const rawLinkedinUrl = prompt('üîó Collez l\'URL du profil LinkedIn (optionnel) :') || '';
            let linkedinUrl = '';
            if (rawLinkedinUrl.trim() !== '' && isValidLinkedInURL(rawLinkedinUrl.trim())) {
                linkedinUrl = rawLinkedinUrl.trim();
            }
            
            const extracted = extractProfileInfo(text);
            let firstName = extracted.firstName || (linkedinUrl ? extractNameFromLinkedInUrl(linkedinUrl).firstName : '') || 'Pr√©nom';
            let lastName = extracted.lastName || (linkedinUrl ? extractNameFromLinkedInUrl(linkedinUrl).lastName : '') || 'Nom';
            
            let autoDept = '', maxScore = 0;
            state.departments.forEach(dept => {
                const deptAnalysis = calculateDeptScore(text, dept.name);
                if (deptAnalysis.score > maxScore) { 
                    maxScore = deptAnalysis.score; 
                    autoDept = dept.name; 
                }
            });
            
            if (!autoDept) autoDept = state.departments[0].name;
            
            const deptAnalysis = calculateDeptScore(text, autoDept);
            const adnAnalysis = analyzeADN(text);
            
            const newEmployee = {
                id: Date.now(), 
                firstName, lastName, 
                position: extracted.position || 'Poste', 
                department: autoDept,
                company: extracted.company || state.targetCompany, 
                linkedinUrl, email: '', profileText: text,
                globalScore: adnAnalysis.globalScore, 
                adnFoundGroups: adnAnalysis.foundGroups,
                adnMissingGroups: adnAnalysis.missingGroups,
                adnTotalGroups: adnAnalysis.totalGroups,
                wordCount: adnAnalysis.wordCount,
                analyzedAt: adnAnalysis.analyzedAt, 
                deptScore: deptAnalysis.score, 
                deptFoundKeywords: deptAnalysis.foundKeywords,
                deptMissingKeywords: deptAnalysis.missingKeywords, 
                deptTotalKeywords: deptAnalysis.totalKeywords,
                deptSectionDetails: deptAnalysis.sectionDetails,
                deptWeightedPoints: deptAnalysis.weightedPoints,
                deptDetailedFound: deptAnalysis.detailedFound,
                createdAt: new Date().toISOString()
            };
            
            Object.assign(newEmployee, calculateLinkedInScore(text, newEmployee), calculateSSI(text, newEmployee));
            Object.assign(newEmployee, calculateATSScore(text, newEmployee, autoDept));
            
            state.employees.push(newEmployee);
            saveState();
            render();
            
            const linkedinInfo = newEmployee.linkedinIsNoGo ? ' ‚õî NO-GO' : ' ' + newEmployee.linkedinLevel;
            alert('‚úÖ Profil ajout√© : ' + newEmployee.firstName + ' ' + newEmployee.lastName + 
                '\n\nüìä Score SSI : ' + newEmployee.ssiScore + '/100' +
                '\nüîµ Score LinkedIn Pro : ' + newEmployee.linkedinGlobalScore + '/100' + linkedinInfo +
                '\nüß¨ Score ADN : ' + newEmployee.globalScore + '/100' +
                '\nüíº Score M√©tier : ' + newEmployee.deptScore + '/100' +
                '\nüéØ Score ATS : ' + newEmployee.atsScore + '/100');
        }

        function deleteEmployee(id) {
            if (confirm('Supprimer ce collaborateur ?')) {
                state.employees = state.employees.filter(emp => emp.id !== id);
                saveState();
                render();
            }
        }

        function viewEmployee(id) {
            state.selectedEmployee = state.employees.find(emp => emp.id === id);
            state.currentView = 'detail';
            render();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({ employees: state.employees, adnKeywords: state.adnKeywords, departments: state.departments }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'linkedin-analyzer-cyrus-' + Date.now() + '.json';
            a.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es ?')) {
                state.employees = [];
                saveState();
                render();
            }
        }

        function getScoreBadge(score) {
            if (score >= 70) return 'bg-green-100 text-green-800';
            if (score >= 40) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function getScoreColor(score) {
            if (score >= 70) return 'text-green-600';
            if (score >= 40) return 'text-yellow-600';
            return 'text-red-600';
        }

        // ===== RENDU =====

        function renderHeader() {
            return `<header class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 shadow-lg no-print">
                <div class="max-w-7xl mx-auto px-4 py-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-white">üèõÔ∏è Analyseur LinkedIn - Cyrus Herez</h1>
                            <p class="text-sm text-blue-200 mt-1">Alignement des profils avec l'ADN de l'entreprise ‚Ä¢ v4</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportData()" class="p-2 text-white hover:bg-blue-700 rounded-lg transition" title="Exporter JSON">üì•</button>
                            <button onclick="clearAllData()" class="p-2 text-white hover:bg-red-600 rounded-lg transition" title="Tout supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            </header>`;
        }

        function renderEmployeeList() {
            const avgScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.globalScore || 0), 0) / state.employees.length) : 0;
            const avgLinkedInScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.linkedinGlobalScore || 0), 0) / state.employees.length) : 0;
            const avgSSIScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.ssiScore || 0), 0) / state.employees.length) : 0;
            const avgATSScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.atsScore || 0), 0) / state.employees.length) : 0;
            const avgMetierScore = state.employees.length > 0 ? Math.round(state.employees.reduce((sum, emp) => sum + (emp.deptScore || 0), 0) / state.employees.length) : 0;
            const noGoCount = state.employees.filter(e => e.linkedinIsNoGo).length;
            
            let html = `<div class="space-y-4">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200 shadow-sm">
                    <h3 class="text-lg font-bold text-blue-900 mb-2">üèõÔ∏è Cyrus Herez - Gestion Patrimoniale</h3>
                    <p class="text-sm text-blue-800 mb-3">${state.companyMission}</p>
                </div>`;
            
            if (state.employees.length > 0) {
                html += `<div class="grid grid-cols-7 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-blue-600">${state.employees.length}</p><p class="text-xs text-gray-600 mt-1">Profils</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-purple-600">${avgSSIScore}</p><p class="text-xs text-gray-600 mt-1">SSI</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-cyan-600">${avgLinkedInScore}</p><p class="text-xs text-gray-600 mt-1">LinkedIn Pro</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-green-600">${avgScore}</p><p class="text-xs text-gray-600 mt-1">ADN</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-indigo-600">${avgMetierScore}</p><p class="text-xs text-gray-600 mt-1">M√©tier</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><p class="text-2xl font-bold text-amber-600">${avgATSScore}</p><p class="text-xs text-gray-600 mt-1">ATS</p></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm text-center border ${noGoCount > 0 ? 'bg-red-50 border-red-200' : ''}"><p class="text-2xl font-bold ${noGoCount > 0 ? 'text-red-600' : 'text-gray-400'}">${noGoCount}</p><p class="text-xs text-gray-600 mt-1">No-Go</p></div>
                </div>`;
            }
            
            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="quickAdd()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white py-5 rounded-xl hover:from-blue-700 hover:to-blue-800 shadow-lg transition transform hover:scale-[1.02]">
                    <div class="font-bold text-lg">‚ö° Coller le texte</div>
                    <div class="text-sm opacity-90 mt-1">Copier-coller le profil LinkedIn</div>
                </button>
                <button onclick="state.currentView = 'add'; render();" class="bg-white border-2 border-gray-300 text-gray-700 py-5 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition">
                    <div class="font-bold text-lg">‚ûï Saisie manuelle</div>
                    <div class="text-sm text-gray-500 mt-1">Formulaire complet</div>
                </button>
            </div>`;
            
            html += '<div class="grid gap-4">';
            state.employees.forEach(emp => {
                const linkedinNoGoBadge = emp.linkedinIsNoGo ? '<span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700 font-medium">‚õî NO-GO</span>' : '';
                const cyrusHerezBadge = emp.linkedinHasCyrusHerez ? '<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700">‚úì Cyrus Herez</span>' : '<span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">‚ö†Ô∏è Sans Cyrus Herez</span>';
                
                html += `<div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-all border ${emp.linkedinIsNoGo ? 'border-l-4 border-l-red-500' : 'border-gray-100'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <h3 class="text-lg font-bold text-gray-900">${emp.firstName} ${emp.lastName}</h3>
                                ${linkedinNoGoBadge}
                                ${cyrusHerezBadge}
                            </div>
                            <p class="text-gray-600">${emp.position}</p>
                            <div class="flex gap-2 mt-2 text-sm">
                                <span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded font-medium">${emp.department}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.ssiScore || 0)}">${emp.ssiScore || 0}</div><p class="text-xs text-gray-500 mt-1">SSI</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.linkedinGlobalScore || 0)}">${emp.linkedinGlobalScore || 0}</div><p class="text-xs text-gray-500 mt-1">Pro</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.globalScore || 0)}">${emp.globalScore || 0}</div><p class="text-xs text-gray-500 mt-1">ADN</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.deptScore || 0)}">${emp.deptScore || 0}</div><p class="text-xs text-gray-500 mt-1">M√©tier</p></div>
                            <div class="text-center px-2"><div class="px-2 py-1 rounded-lg text-sm font-bold ${getScoreBadge(emp.atsScore || 0)}">${emp.atsScore || 0}</div><p class="text-xs text-gray-500 mt-1">ATS</p></div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                        <button onclick="viewEmployee(${emp.id})" class="flex-1 px-4 py-2.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-medium transition">üìä Voir la fiche</button>
                        <button onclick="exportToPDF(state.employees.find(e => e.id === ${emp.id}))" class="px-4 py-2.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 font-medium transition">üìÑ PDF</button>
                        ${emp.linkedinUrl && isValidLinkedInURL(emp.linkedinUrl) ? '<a href="' + emp.linkedinUrl + '" target="_blank" class="px-4 py-2.5 text-blue-600 hover:bg-blue-50 rounded-lg transition">üîó</a>' : ''}
                        <button onclick="deleteEmployee(${emp.id})" class="px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            if (state.employees.length === 0) {
                html += `<div class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                    <div class="text-6xl mb-4">üìä</div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun profil analys√©</h3>
                    <p class="text-gray-600">Commencez par ajouter un profil LinkedIn</p>
                </div>`;
            }
            
            html += '</div>';
            return html;
        }

        function renderEmployeeDetail() {
            const emp = state.selectedEmployee;
            if (!emp) return '';
            
            const recommendations = generateRecommendations(emp);
            
            let html = `<div id="profile-detail" class="space-y-6">
                <div class="flex justify-between items-center no-print">
                    <button onclick="state.currentView = 'list'; render();" class="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2">
                        <span>‚Üê</span> Retour √† la liste
                    </button>
                    <button onclick="exportToPDF(state.selectedEmployee)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition flex items-center gap-2">
                        üìÑ Exporter en PDF
                    </button>
                </div>
                
                <!-- En-t√™te profil -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center gap-3 mb-2 flex-wrap">
                                <h2 class="text-3xl font-bold text-gray-900">${emp.firstName} ${emp.lastName}</h2>
                                ${emp.linkedinIsNoGo ? '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">‚õî NO-GO</span>' : ''}
                                ${emp.linkedinHasCyrusHerez ? '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">‚úì Cyrus Herez</span>' : '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">‚ö†Ô∏è Cyrus Herez absent</span>'}
                            </div>
                            <p class="text-lg text-gray-600">${emp.position}</p>
                            <p class="text-gray-500">${emp.department} ‚Ä¢ ${emp.company}</p>
                        </div>
                    </div>
                    ${emp.linkedinUrl ? '<a href="' + emp.linkedinUrl + '" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:underline text-sm bg-blue-50 px-4 py-2 rounded-full">üîó Voir le profil LinkedIn</a>' : ''}
                </div>
                
                <!-- Scores globaux -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="text-lg font-bold mb-4">üèÜ Scores globaux</h3>
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center p-4 bg-purple-50 rounded-xl">
                            <p class="text-sm text-purple-700 font-medium mb-2">üìä SSI</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.ssiScore || 0)}">${emp.ssiScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                        </div>
                        <div class="text-center p-4 bg-cyan-50 rounded-xl">
                            <p class="text-sm text-cyan-700 font-medium mb-2">üîµ LinkedIn Pro</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.linkedinGlobalScore || 0)}">${emp.linkedinGlobalScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                            <p class="text-xs mt-1 ${emp.linkedinIsNoGo ? 'text-red-600 font-bold' : 'text-gray-500'}">${emp.linkedinLevel || ''}</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-xl">
                            <p class="text-sm text-green-700 font-medium mb-2">üß¨ ADN</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.globalScore || 0)}">${emp.globalScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                        </div>
                        <div class="text-center p-4 bg-indigo-50 rounded-xl">
                            <p class="text-sm text-indigo-700 font-medium mb-2">üíº M√©tier</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.deptScore || 0)}">${emp.deptScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                        </div>
                        <div class="text-center p-4 bg-amber-50 rounded-xl">
                            <p class="text-sm text-amber-700 font-medium mb-2">üéØ ATS</p>
                            <span class="text-3xl font-bold ${getScoreColor(emp.atsScore || 0)}">${emp.atsScore || 0}</span>
                            <span class="text-gray-500">/100</span>
                            <p class="text-xs mt-1">${emp.atsDecision || ''}</p>
                        </div>
                    </div>
                </div>`;
            
            // ===== SSI Section =====
            const ssiLevel = emp.ssiScore >= 75 ? 'üèÜ Excellent' : emp.ssiScore >= 55 ? '‚úÖ Bon' : emp.ssiScore >= 35 ? '‚ö†Ô∏è √Ä d√©velopper' : 'üî¥ Faible';
            const ssiDescription = emp.ssiScore >= 75 ? 
                `${emp.firstName} fait partie des meilleurs profils du secteur avec un SSI de ${emp.ssiScore}/100. Son personal branding est solide et son activit√© LinkedIn g√©n√®re de l'engagement.` :
                emp.ssiScore >= 55 ? 
                `${emp.firstName} a un bon niveau d'activit√© sur LinkedIn avec un SSI de ${emp.ssiScore}/100.` :
                `${emp.firstName} a un SSI de ${emp.ssiScore}/100, inf√©rieur √† la moyenne du secteur (32).`;
            
            html += `<div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-xl border border-purple-200">
                <h3 class="text-lg font-bold mb-4 text-purple-900">üìä Social Selling Index (SSI)</h3>
                
                <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${emp.ssiScore >= 55 ? 'border-green-500' : emp.ssiScore >= 35 ? 'border-yellow-500' : 'border-red-500'}">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">${ssiLevel}</span>
                        <span class="text-2xl font-bold ${getScoreColor(emp.ssiScore || 0)}">${emp.ssiScore || 0}/100</span>
                    </div>
                    <p class="text-gray-600 text-sm">${ssiDescription}</p>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <span class="text-xs font-medium text-green-700">Points forts :</span>
                        ${(emp.ssiStrengths || []).map(s => `<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">${s.icon} ${s.label}</span>`).join('')}
                    </div>
                    ${(emp.ssiWeaknesses || []).length > 0 ? `<div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs font-medium text-orange-700">√Ä am√©liorer :</span>
                        ${emp.ssiWeaknesses.map(s => `<span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs">${s.icon} ${s.label}</span>`).join('')}
                    </div>` : ''}
                </div>
                
                <!-- Classements -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg text-center">
                        <p class="text-xs text-gray-500 mb-1">Classement Secteur</p>
                        <p class="text-2xl font-bold text-green-600">Top ${emp.ssiSectorRanking}%</p>
                        <p class="text-xs text-gray-400">Moyenne secteur : ${emp.ssiAvgSectorScore}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg text-center">
                        <p class="text-xs text-gray-500 mb-1">Classement R√©seau</p>
                        <p class="text-2xl font-bold text-blue-600">Top ${emp.ssiNetworkRanking}%</p>
                        <p class="text-xs text-gray-400">Moyenne r√©seau : ${emp.ssiAvgNetworkScore}</p>
                    </div>
                </div>
                
                <!-- Barres de progression SSI -->
                <div class="bg-white p-4 rounded-lg mb-4">
                    <h4 class="font-medium text-gray-700 mb-3">Les quatre facteurs SSI</h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-600">üèÜ Marque professionnelle</span>
                                <span class="text-sm font-bold ${getScoreColor((emp.ssiBrandScore/25)*100)}">${emp.ssiBrandScore || 0}/25</span>
                            </div>
                            <div class="progress-bar bg-gray-200">
                                <div class="progress-fill ${getProgressGradient((emp.ssiBrandScore/25)*100)}" style="width: ${((emp.ssiBrandScore || 0)/25)*100}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-600">üë• Trouver les bonnes personnes</span>
                                <span class="text-sm font-bold ${getScoreColor((emp.ssiPeopleScore/25)*100)}">${emp.ssiPeopleScore || 0}/25</span>
                            </div>
                            <div class="progress-bar bg-gray-200">
                                <div class="progress-fill ${getProgressGradient((emp.ssiPeopleScore/25)*100)}" style="width: ${((emp.ssiPeopleScore || 0)/25)*100}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-600">üí¨ √âchanger des informations</span>
                                <span class="text-sm font-bold ${getScoreColor((emp.ssiEngagementScore/25)*100)}">${emp.ssiEngagementScore || 0}/25</span>
                            </div>
                            <div class="progress-bar bg-gray-200">
                                <div class="progress-fill ${getProgressGradient((emp.ssiEngagementScore/25)*100)}" style="width: ${((emp.ssiEngagementScore || 0)/25)*100}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-gray-600">ü§ù √âtablir des relations</span>
                                <span class="text-sm font-bold ${getScoreColor((emp.ssiRelationScore/25)*100)}">${emp.ssiRelationScore || 0}/25</span>
                            </div>
                            <div class="progress-bar bg-gray-200">
                                <div class="progress-fill ${getProgressGradient((emp.ssiRelationScore/25)*100)}" style="width: ${((emp.ssiRelationScore || 0)/25)*100}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Plan d'action SSI -->
                ${recommendations.ssi.length > 0 ? `
                <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                    <h4 class="font-medium text-amber-800 mb-3">üìã Plan d'action SSI</h4>
                    ${recommendations.ssi.map(rec => `
                        <div class="mb-3">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-xs font-bold ${rec.priority === 'haute' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">‚óè Priorit√© ${rec.priority}</span>
                                <span class="font-medium text-gray-700">${rec.icon} ${rec.title}</span>
                            </div>
                            <ul class="text-sm text-gray-600 ml-6 list-disc">
                                ${rec.actions.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>` : ''}
            </div>`;
            
            // ===== LinkedIn Pro Section =====
            const linkedinDescription = emp.linkedinGlobalScore >= 85 ?
                `Le profil de ${emp.firstName} est exemplaire : positionnement clair, exp√©riences d√©taill√©es avec r√©sultats, cr√©dibilit√© √©tablie. C'est un profil pr√™t pour le recrutement ou la prospection.` :
                emp.linkedinGlobalScore >= 70 ?
                `${emp.firstName} a un profil solide et exploitable. Quelques optimisations pourraient le rendre encore plus percutant.` :
                `Le profil de ${emp.firstName} n√©cessite des am√©liorations pour √™tre pleinement efficace.`;
            
            html += `<div class="bg-gradient-to-r from-cyan-50 to-blue-50 p-6 rounded-xl border border-cyan-200">
                <h3 class="text-lg font-bold mb-4 text-cyan-900">üîµ √âvaluation LinkedIn Pro</h3>
                
                <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${emp.linkedinGlobalScore >= 70 ? 'border-green-500' : emp.linkedinGlobalScore >= 50 ? 'border-yellow-500' : 'border-red-500'}">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl font-bold ${getScoreColor(emp.linkedinGlobalScore || 0)}">${emp.linkedinGlobalScore || 0}/100</span>
                        <span class="px-2 py-0.5 rounded text-sm font-medium ${emp.linkedinGlobalScore >= 85 ? 'bg-green-100 text-green-700' : emp.linkedinGlobalScore >= 70 ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'}">${emp.linkedinLevel}</span>
                        <span class="text-gray-600">${emp.linkedinVerdict}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${linkedinDescription}</p>
                    
                    <div class="flex flex-wrap gap-1 mt-2">
                        <span class="text-xs font-medium text-gray-500">‚úÖ Points forts :</span>
                        ${(emp.linkedinStrengths || []).map(s => `<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">${s.icon} ${s.label}</span>`).join('')}
                    </div>
                    ${(emp.linkedinWeaknesses || []).length > 0 ? `
                    <div class="flex flex-wrap gap-1 mt-2">
                        <span class="text-xs font-medium text-gray-500">‚ö†Ô∏è √Ä am√©liorer :</span>
                        ${emp.linkedinWeaknesses.map(s => `<span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs">${s.icon} ${s.label}</span>`).join('')}
                    </div>` : ''}
                </div>
                
                <!-- Barres de progression LinkedIn Pro -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">üÜî Identit√© & Cr√©dibilit√©</span>
                            <span class="text-sm font-bold ${getScoreColor((emp.linkedinIdentityScore/15)*100)}">${emp.linkedinIdentityScore || 0}/15</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="progress-fill ${getProgressGradient((emp.linkedinIdentityScore/15)*100)}" style="width: ${((emp.linkedinIdentityScore || 0)/15)*100}%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">üéØ Proposition de valeur</span>
                            <span class="text-sm font-bold ${getScoreColor((emp.linkedinPositioningScore/20)*100)}">${emp.linkedinPositioningScore || 0}/20</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="progress-fill ${getProgressGradient((emp.linkedinPositioningScore/20)*100)}" style="width: ${((emp.linkedinPositioningScore || 0)/20)*100}%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">üíº Exp√©rience professionnelle</span>
                            <span class="text-sm font-bold ${getScoreColor((emp.linkedinExperienceScore/25)*100)}">${emp.linkedinExperienceScore || 0}/25</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="progress-fill ${getProgressGradient((emp.linkedinExperienceScore/25)*100)}" style="width: ${((emp.linkedinExperienceScore || 0)/25)*100}%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">‚≠ê Comp√©tences & Expertise</span>
                            <span class="text-sm font-bold ${getScoreColor((emp.linkedinCompetenceScore/20)*100)}">${emp.linkedinCompetenceScore || 0}/20</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="progress-fill ${getProgressGradient((emp.linkedinCompetenceScore/20)*100)}" style="width: ${((emp.linkedinCompetenceScore || 0)/20)*100}%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">üì¢ Engagement & Visibilit√©</span>
                            <span class="text-sm font-bold ${getScoreColor((emp.linkedinEngagementScore/10)*100)}">${emp.linkedinEngagementScore || 0}/10</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="progress-fill ${getProgressGradient((emp.linkedinEngagementScore/10)*100)}" style="width: ${((emp.linkedinEngagementScore || 0)/10)*100}%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">üéì Formation & Acad√©mique</span>
                            <span class="text-sm font-bold ${getScoreColor((emp.linkedinFormationScore/10)*100)}">${emp.linkedinFormationScore || 0}/10</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="progress-fill ${getProgressGradient((emp.linkedinFormationScore/10)*100)}" style="width: ${((emp.linkedinFormationScore || 0)/10)*100}%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Pr√©conisations LinkedIn -->
                ${recommendations.linkedin.length > 0 ? `
                <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                    <h4 class="font-medium text-amber-800 mb-3">üìã Pr√©conisations LinkedIn Pro</h4>
                    ${recommendations.linkedin.map(rec => `
                        <div class="mb-3">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-xs font-bold ${rec.priority === 'haute' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">‚óè Priorit√© ${rec.priority}</span>
                                <span class="font-medium text-gray-700">${rec.icon} ${rec.title}</span>
                            </div>
                            <ul class="text-sm text-gray-600 ml-6 list-disc">
                                ${rec.tips ? rec.tips.map(t => `<li>${t}</li>`).join('') : rec.actions.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>` : ''}
            </div>`;
            
            // ===== ADN Section =====
            html += `<div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200">
                <h3 class="text-lg font-bold mb-4 text-green-900">üß¨ ADN Cyrus Herez</h3>
                <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${emp.globalScore >= 50 ? 'border-green-500' : 'border-orange-500'}">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl font-bold ${getScoreColor(emp.globalScore || 0)}">${emp.globalScore || 0}/100</span>
                        <span class="text-gray-600">${emp.adnFoundGroups?.length || 0}/${emp.adnTotalGroups || 14} th√©matiques couvertes</span>
                    </div>
                </div>
                ${emp.adnFoundGroups && emp.adnFoundGroups.length > 0 ? '<div class="mb-3"><p class="text-sm font-medium text-green-700 mb-2">‚úì Th√©matiques pr√©sentes :</p><div class="flex flex-wrap gap-2">' + emp.adnFoundGroups.map(g => '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">' + g.name + '</span>').join('') + '</div></div>' : ''}
                ${emp.adnMissingGroups && emp.adnMissingGroups.length > 0 ? '<div><p class="text-sm font-medium text-orange-700 mb-2">‚úó Th√©matiques √† ajouter :</p><div class="flex flex-wrap gap-2">' + emp.adnMissingGroups.map(g => '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">' + g.name + '</span>').join('') + '</div></div>' : ''}
                
                ${recommendations.adn.length > 0 ? `
                <div class="bg-amber-50 p-4 rounded-lg border border-amber-200 mt-4">
                    <h4 class="font-medium text-amber-800 mb-2">üìã Pr√©conisations ADN</h4>
                    ${recommendations.adn.map(rec => `
                        <ul class="text-sm text-gray-600 list-disc ml-4">
                            ${rec.actions.map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    `).join('')}
                </div>` : ''}
            </div>`;
            
            // ===== M√©tier Section =====
            html += `<div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-xl border border-indigo-200">
                <h3 class="text-lg font-bold mb-4 text-indigo-900">üíº Score M√©tier - ${emp.department}</h3>
                <div class="bg-white p-4 rounded-lg mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-medium">Score global</span>
                        <span class="text-2xl font-bold ${getScoreColor(emp.deptScore || 0)}">${emp.deptScore || 0}/100</span>
                    </div>
                    <p class="text-sm text-gray-600">${emp.deptFoundKeywords?.length || 0} mots-cl√©s trouv√©s (pond√©r√©s: ${emp.deptWeightedPoints || 0} pts)</p>
                </div>`;
            
            if (emp.deptSectionDetails) {
                emp.deptSectionDetails.forEach(section => {
                    const sectionColor = section.weight === 3 ? 'green' : (section.weight === 2 ? 'yellow' : 'gray');
                    html += `<div class="bg-white p-4 rounded-lg mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 bg-${sectionColor}-100 text-${sectionColor}-700 rounded text-xs font-bold">x${section.weight}</span>
                                <span class="font-medium text-gray-800">${section.name}</span>
                            </div>
                            <span class="font-bold ${getScoreColor((section.foundCount/section.totalCount)*100)}">${section.foundCount}/${section.totalCount}</span>
                        </div>
                        <div class="progress-bar bg-gray-200 mb-2">
                            <div class="progress-fill ${getProgressGradient((section.foundCount/section.totalCount)*100)}" style="width: ${(section.foundCount/section.totalCount)*100}%"></div>
                        </div>
                        ${section.found.length > 0 ? '<div class="flex flex-wrap gap-1 mb-2">' + section.found.map(k => '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">‚úì ' + k + '</span>').join('') + '</div>' : ''}
                    </div>`;
                });
            }
            
            html += `${recommendations.metier.length > 0 ? `
                <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                    <h4 class="font-medium text-amber-800 mb-2">üìã Pr√©conisations M√©tier</h4>
                    ${recommendations.metier.slice(0, 3).map(rec => `
                        <div class="mb-2">
                            <span class="text-sm font-medium text-gray-700">${rec.icon} ${rec.title}</span>
                            <ul class="text-sm text-gray-600 list-disc ml-4">
                                ${rec.actions.slice(0, 3).map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>` : ''}
            </div>`;
            
            html += '</div>';
            return html;
        }

        function renderAddForm() {
            let deptOptions = '<option value="">S√©lectionner...</option>';
            state.departments.forEach(d => {
                deptOptions += `<option value="${d.name}">${d.name}</option>`;
            });
            
            return `<div class="bg-white p-8 rounded-xl shadow-sm max-w-3xl mx-auto border">
                <h2 class="text-2xl font-bold mb-6">‚ûï Ajouter un collaborateur</h2>
                <form onsubmit="handleAddEmployee(event); return false;" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Pr√©nom *</label><input type="text" id="firstName" required class="w-full px-4 py-3 border rounded-lg" /></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label><input type="text" id="lastName" required class="w-full px-4 py-3 border rounded-lg" /></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Poste</label><input type="text" id="position" class="w-full px-4 py-3 border rounded-lg" /></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Service</label><select id="department" class="w-full px-4 py-3 border rounded-lg">${deptOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Entreprise</label><input type="text" id="company" value="${state.targetCompany}" class="w-full px-4 py-3 border rounded-lg" /></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">üîó URL LinkedIn</label><input type="url" id="linkedinUrl" class="w-full px-4 py-3 border rounded-lg" /></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Profil LinkedIn (texte) *</label><textarea id="profileText" required class="w-full px-4 py-3 border rounded-lg h-48" placeholder="Collez le contenu du profil LinkedIn..."></textarea></div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-lg hover:bg-blue-700 font-medium">‚úÖ Ajouter</button>
                        <button type="button" onclick="state.currentView = 'list'; render();" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 font-medium">‚ùå Annuler</button>
                    </div>
                </form>
            </div>`;
        }

        function handleAddEmployee(event) {
            event.preventDefault();
            const profileText = document.getElementById('profileText').value;
            const linkedinUrl = document.getElementById('linkedinUrl')?.value || '';
            const department = document.getElementById('department').value || state.departments[0].name;
            
            if (linkedinUrl && !isValidLinkedInURL(linkedinUrl)) { alert('‚ö†Ô∏è URL LinkedIn invalide'); return; }
            
            const adnAnalysis = analyzeADN(profileText);
            const deptAnalysis = calculateDeptScore(profileText, department);
            
            const newEmployee = {
                id: Date.now(), 
                firstName: document.getElementById('firstName').value, 
                lastName: document.getElementById('lastName').value,
                position: document.getElementById('position').value, 
                department, 
                company: document.getElementById('company').value,
                linkedinUrl, profileText, 
                globalScore: adnAnalysis.globalScore, 
                adnFoundGroups: adnAnalysis.foundGroups,
                adnMissingGroups: adnAnalysis.missingGroups,
                adnTotalGroups: adnAnalysis.totalGroups,
                wordCount: adnAnalysis.wordCount,
                analyzedAt: adnAnalysis.analyzedAt, 
                deptScore: deptAnalysis.score,
                deptFoundKeywords: deptAnalysis.foundKeywords, 
                deptMissingKeywords: deptAnalysis.missingKeywords,
                deptTotalKeywords: deptAnalysis.totalKeywords,
                deptSectionDetails: deptAnalysis.sectionDetails,
                deptWeightedPoints: deptAnalysis.weightedPoints,
                createdAt: new Date().toISOString()
            };
            
            Object.assign(newEmployee, calculateLinkedInScore(profileText, newEmployee), calculateSSI(profileText, newEmployee));
            Object.assign(newEmployee, calculateATSScore(profileText, newEmployee, department));
            
            state.employees.push(newEmployee);
            saveState();
            state.currentView = 'list';
            render();
            alert('‚úÖ Profil ajout√© !');
        }

        function render() {
            const app = document.getElementById('app');
            let content = '';
            if (state.currentView === 'list') content = renderEmployeeList();
            else if (state.currentView === 'detail') content = renderEmployeeDetail();
            else if (state.currentView === 'add') content = renderAddForm();
            app.innerHTML = renderHeader() + '<main class="max-w-7xl mx-auto px-4 py-6">' + content + '</main>';
        }

        loadState();
        render();
    </script>
</body>
</html>
